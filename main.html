<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet Maps & Routing -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <style>
        /* --- General Styles --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Poppins', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
            background-color: #D50000; /* Primary Red Background */
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        :root {
            --primary-red: #D50000;
            --text-dark: #333;
            --bg-grey: #f8f9fa;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        /* --- TOAST NOTIFICATION --- */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px;
        }
        .toast {
            background: rgba(0,0,0,0.85); color: white; padding: 12px 20px; border-radius: 30px;
            font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- HEADER --- */
        #header-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 120px;
            z-index: 10; padding: 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .name-pill {
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);
            padding: 5px 15px 5px 5px; border-radius: 40px;
            display: flex; align-items: center; gap: 10px;
            border: 1px solid rgba(255,255,255,0.3); color: white; max-width: 55%; cursor: pointer;
        }
        .name-pill:active { transform: scale(0.97); }
        .pill-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid white; }
        .pill-info { display: flex; flex-direction: column; justify-content: center; }
        .pill-hello { font-size: 13px; font-weight: 700; line-height: 1.1; }
        .pill-greeting { font-size: 10px; opacity: 0.9; font-weight: 400; line-height: 1.1; margin-top: 2px; }

        .lang-pill {
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);
            padding: 10px 15px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 13px; font-weight: 600;
            cursor: pointer; display: flex; gap: 5px;
        }
        .lang-pill span { opacity: 0.6; transition: 0.3s; }
        .lang-pill span.active { opacity: 1; font-weight: 700; text-decoration: underline; }

        /* --- MAIN CARD --- */
        #main-card {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: calc(100% - 90px);
            background: white; border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.2); z-index: 5;
            padding: 30px 20px 80px 20px; box-sizing: border-box;
            overflow-y: auto; animation: slideUp 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Services Grid */
        .services-grid { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .service-btn { display: flex; flex-direction: column; align-items: center; width: 32%; cursor: pointer; }
        .svc-img-box {
            width: 100%; aspect-ratio: 1/1; background: var(--bg-grey); border-radius: 20px; margin-bottom: 10px;
            display: flex; justify-content: center; align-items: center; border: 1px solid #eee; overflow: hidden;
            transition: transform 0.2s;
        }
        .svc-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .service-btn:active .svc-img-box { transform: scale(0.95); }
        .svc-label { font-weight: 700; font-size: 14px; color: var(--text-dark); }

        /* Other UI Elements */
        .ad-banner { width: 100%; aspect-ratio: 16/9; background: #eee; border-radius: 20px; overflow: hidden; position: relative; margin-bottom: 20px; }
        .ad-banner img { width: 100%; height: 100%; object-fit: cover; }
        .ad-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; }
        
        .activity-card { width: 100%; background: white; border: 1px solid #eee; border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer; margin-bottom: 20px; }
        .act-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .act-title { font-size: 16px; font-weight: 700; color: #333; }
        .act-content { background: #f8f9fa; border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; color: #888; }

        .promo-strip-wrapper { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .promo-strip-item { min-width: 100%; aspect-ratio: 32/9; border-radius: 15px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .promo-strip-item img { width: 100%; height: 100%; object-fit: cover; }

        .tab-view { display: none; flex-direction: column; animation: fadeIn 0.3s ease-in-out; width: 100%; }
        .tab-view.active-view { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- BOTTOM NAV --- */
        #bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 20; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #f0f0f0;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; cursor: pointer; width: 25%; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-red); }

        /* --- RIDE OVERLAY --- */
        #ride-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 3000; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        #ride-overlay.active { transform: translateY(0); }
        
        #ride-map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .leaflet-control-attribution, .leaflet-control-zoom { display: none; }

        /* Ride Top Card */
        #ride-top-card {
            position: absolute; top: 20px; left: 5%; width: 90%; 
            background: white; border-radius: 20px; padding: 20px; box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 10;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        #ride-top-card.collapsed {
            top: 20px; padding: 15px;
        }

        .ride-title { font-weight: 700; margin-bottom: 15px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .collapsed .ride-title { display: none; }
        
        /* Integrated Close Button */
        .close-ride-integrated {
            width: 30px; height: 30px; background: #f0f0f0; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            color: #333; font-size: 14px; position: absolute; top: 15px; right: 15px; transition: 0.3s;
        }
        .collapsed .close-ride-integrated { top: 10px; right: 10px; width: 25px; height: 25px; font-size: 12px; background: #ffebee; color: var(--primary-red); }

        /* Card Content */
        .loc-inputs { margin-bottom: 10px; }
        .loc-input-btn {
            width: 100%; padding: 15px; background: #f8f9fa; border-radius: 12px;
            margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
            color: #555; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid #eee;
            box-sizing: border-box; position: relative;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .dot.blue { background: #2196F3; }
        .dot.red { background: #D50000; }
        .collapsed .loc-inputs, .collapsed .vehicle-btn { display: none; }

        /* Collapsed Summary */
        .summary-row { display: none; flex-direction: column; gap: 10px; width: 100%; padding-right: 30px; }
        .collapsed .summary-row { display: flex; }
        .sum-line { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; color: #333; }
        .sum-txt { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }
        .edit-pencil { color: var(--primary-red); font-size: 12px; padding: 5px; cursor: pointer; margin-left: auto; }
        .sum-meta { font-size: 11px; color: #888; display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 5px; margin-top: 5px; }

        /* Button */
        .btn-red { background:var(--primary-red); color:white; padding:15px; border-radius:15px; border:none; font-weight:700; width:100%; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .btn-red:active { transform: scale(0.98); }

        /* Glowing User Marker */
        .glow-marker {
            width: 20px; height: 20px; background: #2196F3; border-radius: 50%;
            border: 3px solid white; box-shadow: 0 0 10px rgba(33, 150, 243, 0.6);
            position: relative;
        }
        .glow-marker::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; border-radius: 50%; background: rgba(33, 150, 243, 0.4);
            animation: pulse 2s infinite; z-index: -1;
        }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }

        /* Route Selection & Loader */
        #route-options-wrapper {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 30px 30px 0 0;
            padding: 20px; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            z-index: 20; transform: translateY(100%); transition: 0.4s; display: flex; flex-direction: column;
        }
        #route-options-wrapper.active { transform: translateY(0); }
        
        .route-opt {
            padding: 15px; border: 1px solid #eee; border-radius: 15px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .route-opt.selected { border: 2px solid var(--primary-red); background: #fff5f5; }
        .route-opt.recommended::after {
            content: 'Recommended'; position: absolute; top: 0; left: 0;
            background: #4CAF50; color: white; font-size: 9px; padding: 2px 8px;
            border-bottom-right-radius: 10px; font-weight: 700;
        }
        .warn-text { color: #D50000; font-size: 10px; font-weight: 700; display: block; margin-top: 3px; }

        /* Full Screen Loader */
        #fs-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 4000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--primary-red); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Location Skeleton */
        #loc-skeleton-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 5000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; padding: 30px;
        }
        .sk-pulse { width: 80px; height: 80px; background: #eee; border-radius: 50%; margin-bottom: 20px; animation: pulse-grey 1.5s infinite; }
        @keyframes pulse-grey { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }
        
        /* Vehicle Sheet */
        #vehicle-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: white; border-radius: 30px 30px 0 0; padding: 20px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2); z-index: 30;
            transform: translateY(100%); transition: 0.4s; overflow-y: auto;
        }
        #vehicle-sheet.active { transform: translateY(0); }

        /* Search Modal */
        #loc-search-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 4500; transform: translateY(100%); transition: 0.3s;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
        }
        #loc-search-modal.active { transform: translateY(0); }
        .search-pill-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-pill-btn { flex: 1; padding: 12px; background: #eee; border-radius: 12px; font-size: 12px; font-weight: 600; text-align: center; cursor: pointer; }
        .search-input-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; padding: 0 15px; display: flex; align-items: center; margin-bottom: 15px; }
        .search-input-box input { border: none; background: transparent; padding: 15px 0; margin-left: 10px; flex: 1; outline: none; }

        /* Setup Wizard (Minified styling) */
        #setup-wizard { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:6000; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; }
        .step { display:none; width:100%; max-width:400px; text-align:center; animation:fadeIn 0.3s; }
        .step.active { display:block; }
        .input-box input, .input-box select { width:100%; padding:15px; border:2px solid #eee; border-radius:12px; margin-bottom:10px; box-sizing:border-box; }
        .profile-upload { width:100px; height:100px; background:#f4f4f4; border-radius:50%; margin:0 auto 20px; overflow:hidden; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; }

    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOCATION SKELETON / FAILED OVERLAY -->
    <div id="loc-skeleton-overlay" class="hidden">
        <div id="loc-loading-content">
            <div class="sk-pulse"></div>
            <h3 style="color:#333; margin:0;">Finding your location...</h3>
            <p style="color:#888; font-size:13px;">Please wait while we connect to GPS</p>
        </div>
        <div id="loc-failed-content" class="hidden">
            <i class="fa-solid fa-location-slash" style="font-size:60px; color:#D50000; margin-bottom:20px;"></i>
            <h3 style="color:#D50000; margin:0;">Location Access Failed</h3>
            <p style="color:#555; font-size:14px; margin-bottom:30px;">We cannot book a ride without your location. Please enable GPS in your browser settings.</p>
            <button class="btn-red" style="width:auto; padding:10px 40px;" onclick="closeLocOverlay()">Close</button>
        </div>
    </div>

    <!-- HEADER -->
    <div id="header-layer">
        <div class="name-pill" onclick="switchTab('profile')">
            <img src="https://i.ibb.co/5xb03Q1/default-avatar.jpg" class="pill-img" id="ui-profile-img">
            <div class="pill-info">
                <span class="pill-hello">Hello <span id="ui-name">...</span></span>
                <span class="pill-greeting" id="ui-greeting">...</span>
            </div>
        </div>
        <div class="lang-pill" onclick="cycleLanguage()">
            <span id="lang-en" class="active">En</span> · <span id="lang-si">සි</span> · <span id="lang-ta">த</span>
        </div>
    </div>

    <!-- MAIN CARD -->
    <div id="main-card" class="hidden">
        <!-- Views -->
        <div id="view-home" class="tab-view active-view">
            <div class="services-grid">
                <div class="service-btn" onclick="initRideFlow()">
                    <div class="svc-img-box"><img src="https://i.ibb.co/cSDnbNVB/car-final-2.jpg" alt="Ride"></div>
                    <span class="svc-label">Ride</span>
                </div>
                <div class="service-btn" onclick="window.location.href='foods.html'">
                    <div class="svc-img-box"><img src="https://i.ibb.co/8gGtW9xc/bag-final-1.jpg" alt="Food"></div>
                    <span class="svc-label">Food</span>
                </div>
                <div class="service-btn">
                    <div class="svc-img-box"><img src="https://i.ibb.co/67BshY3t/delivery-guy.png" alt="Flash"></div>
                    <span class="svc-label">Flash</span>
                </div>
            </div>
            <div class="ad-banner">
                <div class="ad-badge">Promoted</div>
                <img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg">
            </div>
            <div class="activity-card" onclick="switchTab('activity')">
                <div class="act-header"><span class="act-title">Ongoing Activities</span><i class="fa-solid fa-chevron-right"></i></div>
                <div class="act-content"><i class="fa-solid fa-clipboard-list"></i> No Ongoing Activities</div>
            </div>
            <div class="promo-strip-wrapper">
                <div class="promo-strip-item"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>
                <div class="promo-strip-item"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>
            </div>
        </div>

        <div id="view-activity" class="tab-view">
            <h2 style="margin:0 0 20px 0;">Activity</h2>
            <div class="empty-state" style="text-align:center; padding:50px 0; color:#aaa;">
                <i class="fa-solid fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i><br>No recent records
            </div>
        </div>
        
        <div id="view-profile" class="tab-view">
            <div style="text-align:center; margin-bottom:30px;">
                <img src="https://i.ibb.co/5xb03Q1/default-avatar.jpg" id="prof-view-img" style="width:90px; height:90px; border-radius:50%; object-fit:cover; border:3px solid #eee;">
                <h3 id="prof-view-name" style="margin:10px 0 5px 0;">User</h3>
                <p id="prof-view-email" style="color:#888; font-size:13px; margin:0;">...</p>
            </div>
            <button class="btn-red" style="background:#ffebee; color:#D50000;" onclick="handleLogout()">Log Out</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div id="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')"><i class="fa-solid fa-house"></i><span>Home</span></div>
        <div class="nav-item" id="nav-activity" onclick="switchTab('activity')"><i class="fa-solid fa-clock-rotate-left"></i><span>Activity</span></div>
        <div class="nav-item" id="nav-profile" onclick="switchTab('profile')"><i class="fa-solid fa-user"></i><span>Profile</span></div>
    </div>

    <!-- RIDE OVERLAY -->
    <div id="ride-overlay" class="hidden">
        <div id="ride-map"></div>
        <i id="map-crosshair" class="fa-solid fa-crosshairs" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2; font-size:30px; display:none; text-shadow:0 0 5px white;"></i>
        
        <div id="ride-top-card">
            <div class="close-ride-integrated" onclick="closeRideOverlay()"><i class="fa-solid fa-xmark"></i></div>
            <div class="ride-title">Book a Ride</div>
            
            <div class="summary-row">
                <div class="sum-line"><div class="dot blue"></div> <span class="sum-txt" id="sum-pickup">...</span> <i class="fa-solid fa-pen edit-pencil" onclick="editRoute('pickup')"></i></div>
                <div class="sum-line"><div class="dot red"></div> <span class="sum-txt" id="sum-dropoff">...</span> <i class="fa-solid fa-pen edit-pencil" onclick="editRoute('dropoff')"></i></div>
                <div class="sum-meta"><span id="meta-dist">0 km</span><span id="meta-type" style="color:var(--primary-red); font-weight:700;">...</span></div>
            </div>

            <div class="loc-inputs">
                <div class="loc-input-btn" onclick="openSearch('pickup')"><div class="dot blue"></div> <span id="txt-pickup">Select Your Location</span></div>
                <div class="loc-input-btn" onclick="openSearch('dropoff')"><div class="dot red"></div> <span id="txt-dropoff">Drop Off Location</span></div>
            </div>
            
            <button class="btn-red vehicle-btn" onclick="startRouteSearch()">Show Vehicle Options</button>
        </div>
        
        <!-- Route Options & Loader -->
        <div id="fs-loader" class="hidden">
            <div class="spinner"></div>
            <h3>Finding best route...</h3>
        </div>

        <div id="route-options-wrapper">
            <h3 style="margin-top:0; color:#333;">Select Route</h3>
            <div id="route-list"></div>
            <button class="btn-red" style="margin-top:15px;" onclick="confirmRouteSelection()">Continue</button>
        </div>

        <!-- Vehicle Selection -->
        <div id="vehicle-sheet">
            <h3 style="margin-top:0;">Select Vehicle</h3>
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
                <div style="min-width:90px; padding:10px; border:1px solid #eee; border-radius:10px; text-align:center;">
                    <i class="fa-solid fa-car-side" style="font-size:24px; color:#555;"></i><br><small>Mini</small><br><b>Rs. 450</b>
                </div>
                <div style="min-width:90px; padding:10px; border:1px solid #eee; border-radius:10px; text-align:center;">
                    <i class="fa-solid fa-car" style="font-size:24px; color:#555;"></i><br><small>Sedan</small><br><b>Rs. 700</b>
                </div>
                <div style="min-width:90px; padding:10px; border:1px solid #eee; border-radius:10px; text-align:center;">
                    <i class="fa-solid fa-van-shuttle" style="font-size:24px; color:#555;"></i><br><small>Van</small><br><b>Rs. 1100</b>
                </div>
            </div>
            <button class="btn-red" style="margin-top:20px;" onclick="showToast('Driver Searching...', 'info')">Request Ride</button>
        </div>
    </div>

    <!-- SEARCH MODAL -->
    <div id="loc-search-modal">
        <h3 id="search-title" style="margin-top:0;">Set Location</h3>
        <div class="search-input-box">
            <i class="fa-solid fa-magnifying-glass" style="color:#aaa;"></i>
            <input type="text" id="inp-search" placeholder="Search (e.g. Jaffna, Colombo)" onkeyup="handleSearch(event)">
        </div>
        <div class="search-pill-row">
            <div class="search-pill-btn" onclick="setMyLocation()"><i class="fa-solid fa-location-crosshairs"></i> Your Location</div>
            <div class="search-pill-btn" onclick="startPinPicker()"><i class="fa-solid fa-map-pin"></i> Pick on Map</div>
        </div>
        <div id="search-results" style="flex:1; overflow-y:auto;"></div>
        <button class="btn-red" onclick="closeSearch()">Close</button>
    </div>

    <!-- SETUP WIZARD -->
    <div id="setup-wizard" class="hidden">
        <div class="step active" id="step-1">
            <h2>Get Started</h2>
            <div class="input-box"><input type="text" id="inp-name" placeholder="Full Name"></div>
            <button class="btn-red" onclick="nextStep(1)">Next</button>
        </div>
        <div class="step" id="step-2">
            <h2>Profile Photo</h2>
            <div class="profile-upload" onclick="document.getElementById('f').click()">
                <img id="wiz-img" style="width:100%; height:100%; object-fit:cover; display:none;">
                <i class="fa-solid fa-camera" style="font-size:30px; color:#ccc;" id="wiz-icon"></i>
            </div>
            <input type="file" id="f" class="hidden" onchange="previewImg(event)">
            <button class="btn-red" onclick="finishSetup()">Finish</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4",
            authDomain: "speedo-acb7c.firebaseapp.com",
            databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "speedo-acb7c",
            storageBucket: "speedo-acb7c.firebasestorage.app",
            messagingSenderId: "31066493782",
            appId: "1:31066493782:web:e3e9dfa209fa855bc17cf7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GLOBALS
        let userLiveCoords = null;
        let map = null;
        let pickupMarker = null;
        let dropoffMarker = null;
        let routingControl = null;
        let pickupLatLng = null;
        let dropoffLatLng = null;
        let pickupName = "";
        let dropoffName = "";
        let activeSearchMode = "pickup";
        let tempSelectedRoute = null;

        // LOCAL LOCATIONS DB (Combining with API)
        const localLocations = [
            {n:"Colombo Fort", lat:6.9344, lon:79.8428, d:"Colombo, Western"},
            {n:"Galle Face Green", lat:6.9271, lon:79.8453, d:"Colombo, Western"},
            {n:"Lotus Tower", lat:6.9275, lon:79.8583, d:"Colombo 10"},
            {n:"One Galle Face", lat:6.9255, lon:79.8440, d:"Mall, Colombo"},
            {n:"Jaffna Public Library", lat:9.6615, lon:80.0150, d:"Jaffna, Northern"},
            {n:"Nallur Kandaswamy Kovil", lat:9.6743, lon:80.0298, d:"Jaffna, Northern"},
            {n:"Trincomalee Harbour", lat:8.5690, lon:81.2330, d:"Trincomalee, Eastern"},
            {n:"Koneswaram Temple", lat:8.5833, lon:81.2467, d:"Trincomalee"},
            {n:"Temple of the Tooth", lat:7.2936, lon:80.6413, d:"Kandy, Central"},
            {n:"Sigiriya Rock", lat:7.9570, lon:80.7603, d:"Sigiriya, Central"},
            {n:"Ella Rock", lat:6.8580, lon:81.0520, d:"Ella, Uva"},
            {n:"Nine Arches Bridge", lat:6.8768, lon:81.0608, d:"Ella, Uva"},
            {n:"Unawatuna Beach", lat:6.0113, lon:80.2520, d:"Galle, Southern"},
            {n:"Mirissa Beach", lat:5.9482, lon:80.4716, d:"Matara, Southern"},
            {n:"Batticaloa Fort", lat:7.7102, lon:81.6967, d:"Batticaloa, Eastern"},
            {n:"Arugam Bay", lat:6.8415, lon:81.8340, d:"Pottuvil, Eastern"},
            {n:"Anuradhapura Sacred City", lat:8.3450, lon:80.4000, d:"North Central"}
        ];

        // INIT
        window.addEventListener('load', async () => {
            trackLocation(); // Start GPS tracking immediately
            
            const stored = localStorage.getItem('speedo_user');
            if(stored) {
                document.getElementById('main-skeleton').classList.add('hidden');
                document.getElementById('main-card').classList.remove('hidden');
                document.getElementById('ui-name').innerText = JSON.parse(stored).fullName.split(' ')[0];
            } else {
                document.getElementById('main-skeleton').classList.add('hidden');
                document.getElementById('setup-wizard').classList.remove('hidden');
            }
        });

        // TOAST SYSTEM
        window.showToast = (msg) => {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<i class="fa-solid fa-circle-info" style="color:#4CAF50;"></i> ${msg}`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // LOCATION LOGIC
        function trackLocation() {
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (pos) => { userLiveCoords = [pos.coords.latitude, pos.coords.longitude]; },
                    (err) => { console.log("GPS waiting..."); },
                    { enableHighAccuracy: true }
                );
            }
        }

        window.initRideFlow = () => {
            // Show Skeleton Overlay
            const overlay = document.getElementById('loc-skeleton-overlay');
            const loadDiv = document.getElementById('loc-loading-content');
            const failDiv = document.getElementById('loc-failed-content');
            
            overlay.classList.remove('hidden');
            loadDiv.classList.remove('hidden');
            failDiv.classList.add('hidden');

            let attempts = 0;
            const checkLoc = setInterval(() => {
                attempts++;
                if(userLiveCoords) {
                    clearInterval(checkLoc);
                    overlay.classList.add('hidden');
                    openRideUI();
                } else if(attempts >= 20) { // 10 seconds (20 * 500ms)
                    clearInterval(checkLoc);
                    loadDiv.classList.add('hidden');
                    failDiv.classList.remove('hidden');
                }
            }, 500);
        }

        window.closeLocOverlay = () => document.getElementById('loc-skeleton-overlay').classList.add('hidden');

        // MAP UI
        function openRideUI() {
            document.getElementById('ride-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('ride-overlay').classList.add('active'), 10);

            if(!map) {
                // CartoDB Voyager tiles for better visual
                map = L.map('ride-map', { zoomControl: false }).setView(userLiveCoords, 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(map);

                // Glowing User Marker
                const glowIcon = L.divIcon({ className: 'glow-marker', iconSize: [20, 20], iconAnchor: [10, 10] });
                L.marker(userLiveCoords, {icon: glowIcon}).addTo(map);
            } else {
                map.setView(userLiveCoords, 15);
            }
        }

        window.closeRideOverlay = () => {
            document.getElementById('ride-overlay').classList.remove('active');
            setTimeout(() => document.getElementById('ride-overlay').classList.add('hidden'), 400);
            resetMap();
        }

        function resetMap() {
            if(pickupMarker) map.removeLayer(pickupMarker);
            if(dropoffMarker) map.removeLayer(dropoffMarker);
            if(routingControl) { map.removeControl(routingControl); routingControl = null; }
            pickupMarker = null; dropoffMarker = null; pickupLatLng = null; dropoffLatLng = null;
            document.getElementById('ride-top-card').classList.remove('collapsed');
            document.getElementById('route-options-wrapper').classList.remove('active');
            document.getElementById('vehicle-sheet').classList.remove('active');
            document.getElementById('txt-pickup').innerText = "Select Your Location";
            document.getElementById('txt-dropoff').innerText = "Drop Off Location";
        }

        // SMART MARKERS (No Duplicates)
        function updateMarker(type, latlng) {
            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            const blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            if(type === 'pickup') {
                if(pickupMarker) pickupMarker.setLatLng(latlng);
                else pickupMarker = L.marker(latlng, {icon: blueIcon}).addTo(map);
                pickupLatLng = latlng;
            } else {
                if(dropoffMarker) dropoffMarker.setLatLng(latlng);
                else dropoffMarker = L.marker(latlng, {icon: redIcon}).addTo(map);
                dropoffLatLng = latlng;
            }
            
            // Fit bounds if both exist
            if(pickupLatLng && dropoffLatLng) {
                map.fitBounds([pickupLatLng, dropoffLatLng], {padding: [50, 50]});
            } else {
                map.setView(latlng, 15);
            }
        }

        // SEARCH
        window.openSearch = (type) => {
            activeSearchMode = type;
            document.getElementById('loc-search-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('loc-search-modal').classList.add('active'), 10);
            document.getElementById('search-title').innerText = type === 'pickup' ? "Pick Up" : "Drop Off";
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('inp-search').value = '';
            document.getElementById('inp-search').focus();
        }

        window.closeSearch = () => {
            document.getElementById('loc-search-modal').classList.remove('active');
            setTimeout(() => document.getElementById('loc-search-modal').classList.add('hidden'), 300);
        }

        window.handleSearch = (e) => {
            const q = e.target.value.toLowerCase();
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '';
            if(q.length < 2) return;

            // 1. Local Search
            localLocations.filter(x => x.n.toLowerCase().includes(q)).forEach(x => {
                const d = document.createElement('div');
                d.style.padding='15px'; d.style.borderBottom='1px solid #eee';
                d.innerHTML = `<b>${x.n}</b><br><small style="color:#888">${x.d}</small>`;
                d.onclick = () => selectLocation(x.lat, x.lon, x.n);
                resDiv.appendChild(d);
            });

            // 2. API Search (Nominatim)
            // Debounce in real app, simplistic here
            if(q.length > 3) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=lk&limit=3`)
                .then(r=>r.json()).then(data => {
                    data.forEach(x => {
                        const d = document.createElement('div');
                        d.style.padding='15px'; d.style.borderBottom='1px solid #eee';
                        d.innerHTML = `<b>${x.name || x.display_name.split(',')[0]}</b><br><small style="color:#888">${x.display_name}</small>`;
                        d.onclick = () => selectLocation(x.lat, x.lon, x.name || x.display_name.split(',')[0]);
                        resDiv.appendChild(d);
                    });
                });
            }
        }

        window.selectLocation = (lat, lon, name) => {
            const ll = L.latLng(lat, lon);
            updateMarker(activeSearchMode, ll);
            
            if(activeSearchMode === 'pickup') {
                pickupName = name;
                document.getElementById('txt-pickup').innerText = name;
            } else {
                dropoffName = name;
                document.getElementById('txt-dropoff').innerText = name;
            }
            closeSearch();
        }

        window.setMyLocation = () => {
            if(userLiveCoords) {
                // Reverse Geo simplified
                selectLocation(userLiveCoords[0], userLiveCoords[1], "Current Location");
            }
        }

        window.startPinPicker = () => {
            closeSearch();
            document.getElementById('ride-top-card').classList.add('hidden');
            document.getElementById('map-crosshair').style.display = 'block';
            
            const btn = document.createElement('button');
            btn.className = 'btn-red';
            btn.innerText = 'Confirm Location';
            btn.style.position='absolute'; btn.style.bottom='30px'; btn.style.left='10%'; btn.style.width='80%'; btn.style.zIndex='2000';
            btn.onclick = () => {
                const c = map.getCenter();
                selectLocation(c.lat, c.lng, "Pinned Location");
                document.getElementById('map-crosshair').style.display = 'none';
                document.getElementById('ride-top-card').classList.remove('hidden');
                btn.remove();
            };
            document.getElementById('ride-overlay').appendChild(btn);
        }

        // ROUTE LOGIC
        window.startRouteSearch = () => {
            if(!pickupLatLng || !dropoffLatLng) { showToast('Select both locations'); return; }

            // Show FS Loader
            document.getElementById('fs-loader').classList.remove('hidden');

            // Simulate API Delay then calculate
            setTimeout(() => {
                if(routingControl) map.removeControl(routingControl);
                
                routingControl = L.Routing.control({
                    waypoints: [pickupLatLng, dropoffLatLng],
                    show: false,
                    lineOptions: { styles: [{color: '#D50000', weight: 5}] },
                    createMarker: () => null
                }).addTo(map);

                routingControl.on('routesfound', (e) => {
                    const r = e.routes[0];
                    const dist = (r.summary.totalDistance / 1000).toFixed(1);
                    const time = Math.round(r.summary.totalTime / 60);

                    document.getElementById('fs-loader').classList.add('hidden');
                    
                    // Populate Options
                    const list = document.getElementById('route-list');
                    list.innerHTML = `
                        <div class="route-opt selected recommended" onclick="selectRouteOpt(this, 'Normal', '${dist}')">
                            <div><b>Normal Route</b><br><small>${dist} km • ${time} mins</small></div>
                            <div style="font-size:14px; font-weight:700;">Rs. ${Math.round(dist*60)}</div>
                        </div>
                        <div class="route-opt" onclick="selectRouteOpt(this, 'Expressway', '${dist}')">
                            <div><b>Expressway</b><br><small>${(dist*1.1).toFixed(1)} km • ${Math.round(time*0.7)} mins</small></div>
                            <div style="text-align:right;">
                                <div style="font-size:14px; font-weight:700;">Rs. ${Math.round(dist*75)}</div>
                                <span class="warn-text">Toll Included</span>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('ride-top-card').classList.add('collapsed');
                    document.getElementById('sum-pickup').innerText = pickupName;
                    document.getElementById('sum-dropoff').innerText = dropoffName;
                    
                    // Default selection
                    tempSelectedRoute = { type: 'Normal', dist: dist };
                    document.getElementById('meta-dist').innerText = dist + " km";
                    document.getElementById('meta-type').innerText = "Normal";

                    document.getElementById('route-options-wrapper').classList.add('active');
                });
            }, 1500);
        }

        window.selectRouteOpt = (el, type, dist) => {
            document.querySelectorAll('.route-opt').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
            tempSelectedRoute = { type, dist };
            document.getElementById('meta-dist').innerText = dist + " km";
            document.getElementById('meta-type').innerText = type;
        }

        window.confirmRouteSelection = () => {
            document.getElementById('route-options-wrapper').classList.remove('active');
            document.getElementById('vehicle-sheet').classList.add('active');
        }

        window.editRoute = (type) => {
            // Reset route logic but keep points until changed
            document.getElementById('ride-top-card').classList.remove('collapsed');
            document.getElementById('route-options-wrapper').classList.remove('active');
            document.getElementById('vehicle-sheet').classList.remove('active');
            if(routingControl) { map.removeControl(routingControl); routingControl = null; }
            openSearch(type);
        }

        // SETUP & LOGIN (Stubbed for brevity)
        window.nextStep = (n) => {
            if(n===1 && !document.getElementById('inp-name').value) return showToast("Enter Name");
            document.getElementById(`step-${n}`).classList.remove('active');
            document.getElementById(`step-${n+1}`).classList.add('active');
        }
        window.finishSetup = () => {
            const n = document.getElementById('inp-name').value;
            localStorage.setItem('speedo_user', JSON.stringify({fullName: n, uid: 'test'}));
            document.getElementById('setup-wizard').classList.add('hidden');
            document.getElementById('main-card').classList.remove('hidden');
            document.getElementById('ui-name').innerText = n.split(' ')[0];
        }
        window.handleLogout = () => { localStorage.clear(); location.reload(); }
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-view').forEach(x=>x.classList.remove('active-view'));
            document.getElementById(`view-${t}`).classList.add('active-view');
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            document.getElementById(`nav-${t}`).classList.add('active');
        }

    </script>
</body>
</html>
