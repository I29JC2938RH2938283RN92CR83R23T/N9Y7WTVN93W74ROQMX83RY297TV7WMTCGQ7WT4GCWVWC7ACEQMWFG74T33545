<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet & Routing (Dijkstra Implementation) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <style>
        /* --- General & Theme --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Poppins', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
            /* Red Background as requested */
            background-color: #D50000;
            overflow: hidden;
            user-select: none;
        }

        .hidden { display: none !important; }
        :root {
            --primary-red: #D50000;
            --accent-blue: #2196F3;
            --text-dark: #333;
            --bg-glass: rgba(255, 255, 255, 0.15);
        }

        /* --- Toast Notification --- */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 20000; width: 90%; max-width: 350px; pointer-events: none;
        }
        .toast {
            background: rgba(0,0,0,0.85); color: white; padding: 12px 20px; border-radius: 30px;
            margin-bottom: 10px; text-align: center; font-size: 14px; font-weight: 500;
            animation: fadeIn 0.3s ease-out; pointer-events: auto;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 1. Header --- */
        #header-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100px;
            z-index: 100; padding: 10px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
            /* Keep header red to blend with body */
            background: var(--primary-red); 
        }

        .name-pill {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            padding: 6px 15px 6px 6px;
            border-radius: 30px;
            display: flex; align-items: center; gap: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            color: white; cursor: pointer;
        }
        .name-pill:active { transform: scale(0.97); }
        .pill-img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid white; }
        .pill-info { display: flex; flex-direction: column; justify-content: center; }
        .pill-hello { font-size: 13px; font-weight: 700; line-height: 1.1; }
        .pill-greeting { font-size: 10px; opacity: 0.9; font-weight: 400; line-height: 1.1; margin-top: 2px; }

        .lang-pill {
            background: var(--bg-glass);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            color: white; font-size: 12px; font-weight: 600; cursor: pointer;
            display: flex; gap: 5px;
        }
        .lang-pill span { opacity: 0.6; transition: 0.3s; }
        .lang-pill span.active { opacity: 1; font-weight: 700; text-decoration: underline; }

        /* --- 2. Main Card (White with Rounded Top) --- */
        #main-card {
            position: absolute; top: 100px; left: 0;
            width: 100%; height: calc(100% - 100px);
            background: white;
            /* Top two corners rounded more */
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
            z-index: 50;
            padding: 25px 20px 80px 20px;
            box-sizing: border-box;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- Tab Views --- */
        .tab-view { display: none; flex-direction: column; gap: 20px; width: 100%; }
        .tab-view.active-view { display: flex; }
        @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Services Grid */
        .services-grid { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 25px; }
        .service-btn { display: flex; flex-direction: column; align-items: center; width: 32%; cursor: pointer; }
        .svc-img-box {
            width: 100%; aspect-ratio: 1/1; background: #f4f4f4; border-radius: 20px; margin-bottom: 8px;
            display: flex; justify-content: center; align-items: center; border: 1px solid #eee; overflow: hidden;
        }
        .svc-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .svc-label { font-weight: 700; font-size: 14px; color: var(--text-dark); }

        /* Ad Banner (Full Width) */
        .ad-banner {
            width: 100%; aspect-ratio: 16/9; background: #eee; border-radius: 15px;
            overflow: hidden; position: relative; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .ad-banner img { width: 100%; height: 100%; object-fit: cover; }
        .ad-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; }

        /* Other Views */
        .section-header { font-size: 24px; font-weight: 700; color: var(--text-dark); margin-bottom: 15px; }
        .tabs-pill-container { display: flex; background: #f0f0f0; padding: 5px; border-radius: 15px; margin-bottom: 15px; }
        .tab-pill { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; }
        .tab-pill.active { background: white; color: var(--primary-red); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #aaa; text-align: center; }
        .empty-state i { font-size: 40px; margin-bottom: 15px; color: #ddd; }
        
        /* Profile */
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        .profile-big-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid #f0f0f0; margin-bottom: 10px; }
        .profile-name { font-size: 18px; font-weight: 700; color: var(--text-dark); margin: 0; }
        .profile-email { font-size: 13px; color: #888; margin: 0; }
        .profile-menu-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .menu-left { display: flex; align-items: center; gap: 15px; font-size: 14px; font-weight: 500; color: var(--text-dark); }
        .menu-left i { width: 25px; color: #888; }
        .logout-btn { margin-top: 30px; width: 100%; padding: 15px; border-radius: 15px; background: #ffebee; color: #D50000; font-weight: 700; border: none; cursor: pointer; }

        /* Promo Grid */
        .promo-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .promo-item { margin-bottom: 10px; }
        .promo-card-lg { width: 100%; border-radius: 20px; overflow: hidden; aspect-ratio: 2/1; position: relative; background: #eee; }
        .promo-card-lg img { width: 100%; height: 100%; object-fit: cover; }
        .promo-text { padding: 10px 0; }
        .promo-text h4 { margin: 0; font-size: 15px; color: var(--text-dark); }
        .promo-text p { margin: 2px 0 0; font-size: 12px; color: #888; }

        /* --- 3. Bottom Navigation --- */
        #bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 70px; background: white;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            z-index: 200;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #f0f0f0;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #aaa; cursor: pointer; width: 25%; height: 100%;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .nav-item.active { color: var(--primary-red); }
        .nav-item.active i { transform: translateY(-2px); }

        /* --- 4. Setup Wizard --- */
        #setup-wizard { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:4000; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
        .wizard-container { width:100%; max-width:400px; text-align:center; position: relative; }
        .step { display:none; width:100%; animation: fadeInView 0.4s; }
        .step.active { display:flex; flex-direction:column; }
        .btn-red { background:var(--primary-red); color:white; padding:15px; border-radius:30px; border:none; font-weight:700; width:100%; margin-top:15px; font-size:14px; cursor:pointer; }
        .input-box input, .input-box select { width:100%; padding:15px; border:2px solid #eee; border-radius:12px; margin-bottom:10px; outline:none; box-sizing:border-box; font-size:14px; }
        .input-box label { font-size:13px; font-weight:600; color:#333; display:block; text-align:left; margin-bottom:5px; }
        .profile-upload-container { width:100px; height:100px; background:#f4f4f4; border-radius:50%; margin:0 auto 15px; overflow:hidden; position:relative; border: 2px dashed #ccc; cursor:pointer; }
        
        /* --- Modals --- */
        .modal-card {
            background: white; width: 90%; max-width: 400px;
            border-radius: 20px; padding: 25px; text-align: left;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popIn 0.3s ease-out;
            max-height: 85vh; overflow-y: auto; box-sizing: border-box;
        }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- 5. Ride View (Full Screen Overlay) --- */
        #ride-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f0f0; /* Light grey map background */
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        #ride-overlay.active { transform: translateY(0); }

        #ride-map {
            width: 100%; height: 100%;
            z-index: 1;
            background: #e5e3df;
        }
        /* Hide Leaflet Controls */
        .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }
        /* Hide Routing Container but keep lines */
        .leaflet-routing-container { 
            display: none !important; /* We will render custom UI for route selection */
        }

        /* Ride Top Card */
        #ride-top-card {
            position: absolute; top: 20px; left: 5%; width: 90%; 
            background: white; border-radius: 20px;
            padding: 20px; box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 10;
            transition: 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* Collapsed State */
        #ride-top-card.collapsed {
            top: 80px; padding: 15px;
            display: block; /* Block layout */
        }
        #ride-top-card.collapsed .ride-title { display: none; }
        
        /* Summary Rows (Collapsed View) */
        .summary-row { display: none; flex-direction: column; gap: 8px; width: 100%; }
        .collapsed .summary-row { display: flex; }
        
        /* Buttons */
        .btn-full-red {
            width: 100%; background: var(--primary-red); color: white; border: none;
            padding: 14px; border-radius: 12px; font-weight: 700; font-size: 16px;
            cursor: pointer; box-shadow: 0 4px 10px rgba(213, 0, 0, 0.2);
            margin-top: 10px;
        }
        .btn-full-red:active { transform: scale(0.98); }
        .btn-full-red:disabled { background: #ccc; box-shadow: none; }
        .btn-close {
            position: absolute; top: 15px; right: 15px; background: white; 
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; color: #333; font-size: 18px; z-index: 20;
        }

        /* --- 6. Location Picker Modal --- */
        #loc-picker-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            padding: 20px; box-sizing: border-box; display: flex; flex-direction: column;
        }
        #loc-picker-modal.active { transform: translateY(0); }
        
        .search-pill-row { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .search-pill-btn {
            flex: 1; padding: 12px; background: #f8f9fa; border: 1px solid #eee;
            border-radius: 12px; text-align: center; cursor: pointer; font-weight: 600; color: #555;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .search-pill-btn:active { background: #e0e0e0; }

        .picker-map-wrap { 
            flex: 1; width: 100%; height: 300px; position: relative; background: #e5e3df; 
            border-radius: 15px; overflow: hidden; margin-bottom: 15px;
        }
        .picker-map-wrap::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; 
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0l-10 20h20z' fill='%23000000' fill-opacity='0.5'/%3E%3C/svg%3E");
            z-index: 1000; pointer-events: none; opacity: 0.5;
        }

        /* --- 7. Route Selection Modal --- */
        #route-select-modal {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 30px 30px 0 0;
            padding: 20px; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 20; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: none; flex-direction: column;
        }
        #route-select-modal.active { transform: translateY(0); }

        .route-opt { 
            padding: 15px; border: 1px solid #eee; border-radius: 15px; 
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; position: relative; overflow: hidden; transition: 0.2s;
        }
        .route-opt:active { background: #f9f9f9; }
        .route-opt.selected { border-color: var(--primary-red); background: #fff5f5; box-shadow: 0 0 0 4px rgba(213, 0, 0, 0.1); }
        
        .rec-badge {
            position: absolute; top: 0; left: 0; background: #4CAF50; color: white;
            font-size: 10px; padding: 2px 8px; border-radius: 4px 8px 8px 4px 8px; font-weight: 700; text-transform: uppercase;
        }
        .route-info { flex: 1; margin-right: 10px; }
        .route-title { font-weight: 700; font-size: 14px; color: #333; display: block; }
        .route-meta { font-size: 12px; color: #666; display: block; margin-top: 4px; }
        .route-info-btn { padding: 6px; border: 1px solid #ddd; border-radius: 50%; width: 30px; height: 30px; text-align: center; font-size: 14px; color: #555; background: white; cursor: pointer; }
        .warn-cost { font-size: 10px; color: #D50000; font-weight: 600; display: block; margin-top: 4px; }

        /* --- 8. Vehicle Sheet --- */
        #vehicle-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 30px 30px 0 0;
            padding: 20px; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 10; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        #vehicle-sheet.active { transform: translateY(0); }

        /* --- Directions Modal --- */
        #directions-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; max-height: 70vh;
            background: white; border-radius: 20px; padding: 20px;
            z-index: 3000; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
        }
        .dir-list { overflow-y: auto; flex: 1; padding-right: 10px; margin-top: 10px; }
        .dir-step { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 13px; color: #444; align-items: center; }
        .dir-step i { color: var(--primary-red); margin-top: 3px; font-size: 14px; }

        /* --- Full Screen Modals --- */
        #permission-modal, #warn-modal, #terms-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }

        .perm-card-fs { text-align: center; color: white; padding: 30px; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        .perm-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; }
        .perm-icon { font-size: 60px; margin-bottom: 15px; }
        .perm-loading { font-size: 14px; opacity: 0.8; margin-top: 10px; }
        
        .warn-card-fs { text-align: center; color: white; padding: 30px; max-width: 80%; background: var(--primary-red); border-radius: 15px; }
        .warn-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .warn-icon { font-size: 40px; margin-bottom: 10px; }
        .warn-text { font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .warn-action { margin-top: 10px; }

        .modal-content-fs {
            background: white; width: 90%; max-width: 400px; border-radius: 20px;
            padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 80vh; overflow-y: auto; box-sizing: border-box;
        }
        
        /* Blue Triangle Marker Icon */
        .blue-triangle-icon {
            display: inline-block;
            width: 0; 
            height: 0; 
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid var(--accent-blue);
        }

    </style>
</head>
<body>

    <!-- TOASTS -->
    <div id="toast-container"></div>

    <!-- HEADER -->
    <div id="header-layer">
        <div class="name-pill" onclick="switchTab('profile')">
            <img src="https://ui-avatars.com/api/?name=User&background=fff&color=D50000" class="pill-img" id="ui-avatar">
            <div class="pill-info">
                <span class="pill-hello"><span data-i18n="hello">Hello</span> <span id="ui-name">...</span></span>
                <span class="pill-greeting" id="ui-greeting">...</span>
            </div>
        </div>
        <div class="lang-pill" onclick="cycleLanguage()">
            <span id="lang-en">En</span> <span id="lang-si">සි</span> <span id="lang-ta">த</span>
        </div>
    </div>

    <!-- MAIN CARD -->
    <div id="main-card" class="hidden">
        
        <!-- HOME VIEW -->
        <div id="view-home" class="tab-view active-view">
            <div class="services-grid">
                <div class="service-btn" onclick="initMapAndShow()">
                    <div class="svc-img-box"><i class="fa-solid fa-car-side" style="font-size: 32px; color: #D50000;"></i></div>
                    <span class="svc-label" data-i18n="ride">Ride</span>
                </div>
                <div class="service-btn" onclick="window.location.href='foods.html'">
                    <div class="svc-img-box"><i class="fa-solid fa-utensils" style="font-size: 32px; color: #FF9800;"></i></div>
                    <span class="svc-label" data-i18n="food">Food</span>
                </div>
                <div class="service-btn">
                    <div class="svc-img-box"><i class="fa-solid fa-bolt" style="font-size: 32px; color: #2196F3;"></i></div>
                    <span class="svc-label" data-i18n="flash">Flash</span>
                </div>
            </div>

            <div class="ad-banner">
                <div class="ad-badge">Promoted</div>
                <img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg" alt="Promo">
            </div>

            <div class="promo-strip-wrapper">
                <div class="promo-strip-item" onclick="switchTab('promotions')"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>
                <div class="promo-strip-item"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>
            </div>
        </div>

        <!-- ACTIVITY VIEW -->
        <div id="view-activity" class="tab-view">
            <div class="section-header" data-i18n="activity">Activity</div>
            <div class="tabs-pill-container">
                <div class="tab-pill active" onclick="this.parentNode.children[0].classList.remove('active');this.classList.add('active');">Ongoing</div>
                <div class="tab-pill" onclick="this.parentNode.children[1].classList.remove('active');this.classList.add('active');">Completed</div>
            </div>
            <div class="empty-state">
                <i class="fa-regular fa-folder-open"></i>
                <p>No activity records found</p>
            </div>
        </div>

        <!-- PROMOTIONS VIEW -->
        <div id="view-promotions" class="tab-view">
            <div class="section-header" data-i18n="promotions">Promotions</div>
            <div class="promo-grid" id="promo-container">
                <div class="promo-item">
                    <div class="promo-card-lg"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>
                    <div class="promo-text"><h4>20% Off Rides</h4><p>Use code SPEEDO20</p></div>
                </div>
            </div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="view-profile" class="tab-view">
            <div class="profile-header">
                <img src="https://ui-avatars.com/api/?name=User&background=fff&color=D50000" id="prof-view-img" class="profile-big-img">
                <h3 class="profile-name" id="prof-view-name">User</h3>
                <p class="profile-email" id="prof-view-email">...</p>
            </div>
            <div class="profile-menu">
                <div class="profile-menu-item"><div class="menu-left"><i class="fa-regular fa-user"></i> <span data-i18n="edit_profile">Edit Profile</span></div><i class="fa-solid fa-chevron-right" style="color:#ddd; font-size:12px;"></i></div>
                <div class="profile-menu-item"><div class="menu-left"><i class="fa-regular fa-bookmark"></i> <span data-i18n="saved_places">Saved Places</span></div><i class="fa-solid fa-chevron-right" style="color:#ddd; font-size:12px;"></i></div>
                <div class="profile-menu-item"><div class="menu-left"><i class="fa-regular fa-credit-card"></i> <span data-i18n="payment">Payment Methods</span></div><i class="fa-solid fa-chevron-right" style="color:#ddd; font-size:12px;"></i></div>
                <div class="profile-menu-item"><div class="menu-left"><i class="fa-regular fa-circle-question"></i> <span data-i18n="support">Help & Support</span></div><i class="fa-solid fa-chevron-right" style="color:#ddd; font-size:12px;"></i></div>
                <!-- Settings (Added Sinhala) -->
                <div class="profile-menu-item"><div class="menu-left"><i class="fa-solid fa-gear"></i> <span data-i18n="settings">සැකසුම්</span></div><i class="fa-solid fa-chevron-right" style="color:#ddd; font-size:12px;"></i></div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Log Out</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div id="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
            <i class="fa-solid fa-house"></i> <span data-i18n="home">Home</span>
        </div>
        <div class="nav-item" id="nav-activity" onclick="switchTab('activity')">
            <i class="fa-solid fa-clock-rotate-left"></i> <span data-i18n="activity">Activity</span>
        </div>
        <div class="nav-item" id="nav-promotions" onclick="switchTab('promotions')">
            <i class="fa-solid fa-tag"></i> <span data-i18n="promotions">Promotions</span>
        </div>
        <div class="nav-item" id="nav-profile" onclick="switchTab('profile')">
            <i class="fa-solid fa-user"></i> <span data-i18n="profile">Profile</span>
        </div>
    </div>

    <!-- PERMISSION MODAL (Blocker) -->
    <div id="permission-modal" class="hidden">
        <div class="perm-card-fs">
            <i class="fa-solid fa-location-dot perm-icon"></i>
            <h2 class="perm-title">To Continue, Grant Location Access</h2>
            <p class="perm-loading">Waiting for location signal...</p>
            <!-- No close button, will retry automatically via JS -->
        </div>
    </div>

    <!-- WARNING MODAL -->
    <div id="warn-modal" class="hidden">
        <div class="warn-card-fs">
            <i class="fa-solid fa-triangle-exclamation warn-icon"></i>
            <h3 class="warn-title">Warning</h3>
            <p class="warn-text" data-i18n="app_warn">To keep connected with this service and the app, please do not close the app. If you close the app, it will affect your ride</p>
            <div class="warn-action">
                <input type="checkbox" id="chk-warn"> Do not show again
            </div>
            <button class="btn-full-red" style="background: white; color: #333;" onclick="dismissWarn()">Close</button>
        </div>
    </div>

    <!-- TERMS MODAL -->
    <div id="terms-modal" class="hidden">
        <div class="modal-content-fs">
            <h3 style="color:#D50000; margin-top:0;">Terms & Conditions</h3>
            <div style="font-size:13px; color:#555; line-height:1.6; max-height:60vh; overflow-y:auto; margin-bottom:20px;">
                <p><b>1. Acceptance</b><br>By using Speedo, you agree to our terms.</p>
                <p><b>2. Lost Items</b><br>We care about your lost/stolen and other items. However, please ensure you check your belongings before leaving the vehicle.</p>
                <p><b>3. User Conduct</b><br>Respect drivers and follow laws.</p>
            </div>
            <button class="btn-red" onclick="closeTerms()" style="margin-top:0;">Close</button>
        </div>
    </div>

    <!-- RIDE OVERLAY (Full Screen Map) -->
    <div id="ride-overlay" class="hidden">
        <button class="btn-close" onclick="closeRideOverlay()"><i class="fa-solid fa-xmark"></i></button>
        <div id="ride-map"></div>
        
        <!-- Top Selection Card -->
        <div id="ride-top-card">
            <div class="ride-title" data-i18n="book_ride">Book a Ride</div>
            
            <!-- Expanded State: Pills -->
            <div id="ride-expanded-ui">
                <div class="search-pill-row">
                    <!-- Pickup Pill -->
                    <div class="search-pill-btn" onclick="openLocPicker('pickup')">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <i class="fa-solid fa-circle" style="color:var(--accent-blue); font-size:14px;"></i>
                            <span id="lbl-pickup" data-i18n="sel_pick">Select Your Location</span>
                        </div>
                        <i class="fa-solid fa-pencil" style="color:#999; font-size:12px; cursor:pointer;" onclick="editLocation('pickup')"></i>
                    </div>
                    
                    <!-- Drop Off Pill -->
                    <div class="search-pill-btn" onclick="openLocPicker('dropoff')">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <!-- Blue Triangle Icon -->
                            <i class="blue-triangle-icon"></i>
                            <span id="lbl-dropoff" data-i18n="sel_drop">Drop Off Location</span>
                        </div>
                        <i class="fa-solid fa-pencil" style="color:#999; font-size:12px; cursor:pointer;" onclick="editLocation('dropoff')"></i>
                    </div>
                </div>

                <button id="btn-vehicles" class="btn-full-red" disabled onclick="calculateRoutes()" data-i18n="show_vehicles">Select a Vehicle</button>
            </div>

            <!-- Collapsed State: Summary (Initially Hidden) -->
            <div id="ride-collapsed-ui" class="summary-row">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:10px; flex:1;">
                        <i class="fa-solid fa-circle" style="color:var(--accent-blue); font-size:14px;"></i>
                        <span id="sum-pickup">...</span>
                    </div>
                    <i class="fa-solid fa-pencil" style="color:#999; font-size:12px; cursor:pointer;" onclick="editLocation('pickup')"></i>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:10px; flex:1;">
                        <i class="blue-triangle-icon"></i>
                        <span id="sum-dropoff">...</span>
                    </div>
                    <i class="fa-solid fa-pencil" style="color:#999; font-size:12px; cursor:pointer;" onclick="editLocation('dropoff')"></i>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0;">
                    <span data-i18n="distance">Distance</span> <b id="sum-dist">0 km</b>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0;">
                    <span data-i18n="duration">Duration</span> <b id="sum-time">0 min</b>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0;">
                    <span data-i18n="vehicle">Vehicle</span> <b id="sum-veh">...</b>
                </div>
                <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span data-i18n="total">Total</span> 
                    <span class="price-highlight" id="sum-price">LKR 0.00</span>
                </div>
                <button class="btn-full-red" onclick="bookRide()" data-i18n="book_now">Book Now</button>
            </div>
        </div>

        <!-- ROUTE SELECTION MODAL -->
        <div id="route-select-modal">
            <h3 style="margin:0 0 15px; color:#333;" data-i18n="select_route">Select Route</h3>
            <div id="route-options-container">
                <!-- Options injected via JS -->
            </div>
        </div>

        <!-- VEHICLE SHEET -->
        <div id="vehicle-sheet">
            <h3 style="margin:0 0 15px; color:#333;" data-i18n="choose_veh">Choose Vehicle</h3>
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:15px;">
                <div style="min-width:120px; text-align:center; padding:10px; border:1px solid #eee; border-radius:10px; cursor:pointer;" onclick="selectVehicle('Tuk')">
                    <i class="fa-solid fa-car-side"></i><br><small>Tuk Tuk</small><br><b>Base: 100/-</b>
                </div>
                <div style="min-width:120px; text-align:center; padding:10px; border:1px solid #eee; border-radius:10px; cursor:pointer;" onclick="selectVehicle('Moto')">
                    <i class="fa-solid fa-motorcycle"></i><br><small>Moto</small><br><b>Base: 100/-</b>
                </div>
            </div>
            <button class="btn-full-red" onclick="confirmVehicle()" data-i18n="continue">Continue</button>
        </div>

        <!-- LOCATION PICKER MODAL -->
        <div id="loc-picker-modal">
            <h3 style="margin:0 0 20px; color:#333;" id="loc-picker-title">Set Pickup Location</h3>
            
            <div class="search-pill-row">
                <!-- Search Pill -->
                <div class="search-pill-btn" id="btn-search">
                    <i class="fa-solid fa-magnifying-glass" style="color:#aaa;"></i>
                    <input type="text" id="search-input" placeholder="Search places (e.g. Kandy)" oninput="handleSearchInput(this.value)">
                </div>
            </div>

            <div class="search-pill-row" style="margin-top:0;">
                <!-- My Location Pill -->
                <div class="search-pill-btn" id="btn-my-loc" onclick="getMyLocation()">
                    <i class="fa-solid fa-location-crosshairs" style="color:var(--primary-red);"></i>
                    <span data-i18n="my_loc">Use My Current Location</span>
                </div>
                
                <!-- Pick on Map Pill -->
                <div class="search-pill-btn" id="btn-pick-map" onclick="activateMapPicker()">
                    <i class="fa-solid fa-map-pin" style="color:var(--accent-blue);"></i>
                    <span data-i18n="on_map">Point on Map</span>
                </div>
            </div>

            <!-- Map Area -->
            <div class="picker-map-wrap" id="picker-map-container"></div>
            
            <button class="btn-full-red" onclick="closeLocPicker()" data-i18n="cancel">Cancel</button>
        </div>

        <!-- DIRECTIONS MODAL -->
        <div id="directions-modal" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0;" data-i18n="directions">Route Details</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:18px; color:#555;" onclick="document.getElementById('directions-modal').classList.add('hidden')"></i>
            </div>
            <div class="dir-list" id="dir-steps">
                <!-- Steps injected -->
            </div>
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Init
        const firebaseConfig = { apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4", authDomain: "speedo-acb7c.firebaseapp.com", databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "speedo-acb7c", storageBucket: "speedo-acb7c.firebasestorage.app", messagingSenderId: "31066493782", appId: "1:31066493782:web:e3e9dfa209fa855bc17cf7" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State Variables
        let currentUser = null;
        let base64Profile = "";
        let currentLang = 'en';
        
        // Map Variables
        let mainMap = null;
        let pickerMap = null;
        let routingControl = null;
        
        let pickupMarker = null;
        let dropoffMarker = null;
        
        let pickupCoords = null;
        let dropoffCoords = null;
        
        let pickupAddress = "Select Your Location";
        let dropoffAddress = "Drop Off Location";
        
        let activeEditType = 'pickup'; // 'pickup' or 'dropoff'
        let selectedRouteData = null;
        let selectedVehicle = 'Tuk';
        
        // --- I18N ---
        const i18n = {
            en: { hello: "Hello", morning: "Good Morning", afternoon: "Good Afternoon", evening: "Good Evening", ride: "Ride", food: "Food", flash: "Flash", home:"Home", activity:"Activity", promotions:"Promotions", profile:"Profile", book_ride:"Book a Ride", sel_pick:"Select Your Location", sel_drop:"Drop Off Location", show_vehicles:"Select a Vehicle", select_route:"Select Route", continue:"Continue", distance:"Distance", duration:"Duration", vehicle:"Vehicle", total:"Total", book_now:"Book Now", my_loc:"Use My Current Location", on_map:"Point on Map", directions:"Route Details", settings:"Settings", edit_profile:"Edit Profile", saved_places:"Saved Places", payment:"Payment Methods", support:"Help & Support", app_warn:"To keep connected with this service and the app, please do not close the app. If you close the app, it will affect your ride", cancel:"Cancel", close:"Close" },
            si: { hello: "ආයුබෝවන්", morning: "සුබ උදෑසනක්", afternoon: "සුබ දහවල් කාලයක්", evening: "සුබ සැන්දෑව", ride: "ගමන්", food: "ආහාර", flash: "තැපැල්", home:"මුල් පිටුව", activity:"ක්‍රියාකාරකම්", promotions:"දීමනා", profile:"ගිණුම", book_ride:"සවාරියක් අයකරගන්න", sel_pick:"පිටත් තෝරන්න", sel_drop:"පිටත් අඩවන්න", show_vehicles:"වාහනයක් තෝරන්න", select_route:"මාර්ගය තෝරන්න", continue:"ඉදිරින", distance:"දුර", duration:"කාලය", vehicle:"වාහනය", total:"මුළු", book_now:"දැන්ව අයකරගන්න", my_loc:"මගේ පිහිටිය ස්ථානය භාවිත්", on_map:"සිතියෙන් ස්ථානය", directions:"මාර්ගය විස්තර", settings:"සැකසුම්", edit_profile:"පැත්කරු වෙනස් කරන්න", saved_places:"සුරැකුම්", payment:"ගෙවීම් ක්‍රම", support:"උදව්" },
            ta: { hello: "வணக்கம்", morning: "காலை வணக்கம்", afternoon: "மதிய வணக்கம்", evening: "மாலை வணக்கம்", ride: "சவாரி", food: "உணவு", flash: "கூரியர்", home:"முகப்பு", activity:"செயல்பாடு", promotions:"சலுகைகள்", profile:"சுயவிவரம்", book_ride:"சவாரி முன்பதிவு", sel_pick:"பிக்அப் தேர்வுமை", sel_drop:"இறங்குமிடம் தேர்வுமை", show_vehicles:"வாகனத்தை தேர்வுமை", select_route:"வழியை தேர்வுமை", continue:"தொடர்க", distance:"தூரம்", duration:"நேரம்", vehicle:"வாகனம்", total:"மொத்தம்", book_now:"பதிவு முன்பதிவு", my_loc:"என் இருப்பிடதை", on_map:"வரைப்படத்தில்", directions:"வழி வழிவங்கள்", settings:"அமைப்புகள்", edit_profile:"சுயவிவரம் திருத்து", saved_places:"சேமித்த இடங்கள்", payment:"கட்டண முறைகள்", support:"உதவி" }
        };

        // --- INIT ---
        window.addEventListener('load', async () => {
            const stored = localStorage.getItem('speedo_user');
            if(!stored) { window.location.href = "index.html"; return; }
            currentUser = JSON.parse(stored);

            // Simulate Load
            document.getElementById('main-card').classList.remove('hidden');
            setTimeout(() => {
                initUI();
            }, 500);
        });

        // --- UI HELPERS ---
        window.showToast = (msg) => {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            c.appendChild(t);
            setTimeout(() => { t.remove(); }, 3000);
        }

        window.cycleLanguage = () => {
            const langs = ['en', 'si', 'ta'];
            const idx = langs.indexOf(currentLang);
            currentLang = langs[(idx + 1) % 3];
            localStorage.setItem('speedo_lang', currentLang);
            updateLangState();
        }

        function updateLangState() {
            document.getElementById('lang-en').className = currentLang==='en'?'active':'';
            document.getElementById('lang-si').className = currentLang==='si'?'active':'';
            document.getElementById('lang-ta').className = currentLang==='ta'?'active':'';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if(i18n[currentLang][k]) el.innerText = i18n[currentLang][k];
            });
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active-view'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active-view');
            document.getElementById(`nav-${tab}`).classList.add('active');
        }

        window.handleLogout = () => { if(confirm("Log out?")) { localStorage.removeItem('speedo_user'); window.location.href = "index.html"; } }
        window.dismissWarn = () => {
            const chk = document.getElementById('chk-warn');
            if(chk.checked) localStorage.setItem('speedo_warn_dismiss', 'true');
            document.getElementById('warn-modal').classList.add('hidden');
        }
        window.closeTerms = () => document.getElementById('terms-modal').classList.add('hidden');
        window.closeLocPicker = () => {
            document.getElementById('loc-picker-modal').classList.remove('active');
            // Reset map picker mode to selection mode
        }

        // --- MAP & ROUTING LOGIC ---
        window.initMapAndShow = () => {
            // Warning Check
            if(!localStorage.getItem('speedo_warn_dismiss')) {
                document.getElementById('warn-modal').classList.remove('hidden');
            }
            
            document.getElementById('ride-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('ride-overlay').classList.add('active'), 100);
            setTimeout(() => {
                if(mainMap) {
                    mainMap.invalidateSize();
                    mainMap.setView([6.9271, 79.8612], 13); // Colombo Default
                } else {
                    initMainMap();
                }
            }, 400);
        }

        window.closeRideOverlay = () => {
            document.getElementById('ride-overlay').classList.remove('active');
            setTimeout(() => document.getElementById('ride-overlay').classList.add('hidden'), 400);
            // Reset State
            document.getElementById('ride-expanded-ui').classList.remove('hidden');
            document.getElementById('ride-collapsed-ui').classList.add('hidden');
            document.getElementById('ride-top-card').classList.remove('collapsed');
            
            if(routingControl) {
                mainMap.removeControl(routingControl);
                routingControl = null;
            }
            // Clear Markers
            if(pickupMarker) mainMap.removeLayer(pickupMarker);
            if(dropoffMarker) mainMap.removeLayer(dropoffMarker);
            pickupCoords = null;
            dropoffCoords = null;
            
            document.getElementById('lbl-pickup').innerText = i18n[currentLang].sel_pick;
            document.getElementById('lbl-dropoff').innerText = i18n[currentLang].sel_drop;
            document.getElementById('btn-vehicles').disabled = true;
        }

        function initMainMap() {
            // Detailed Map: CartoDB Voyager
            mainMap = L.map('ride-map', { zoomControl: false }).setView([6.9271, 79.8612], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd', maxZoom: 19, attribution: '&copy; OpenStreetMap, &copy; CARTO'
            }).addTo(mainMap);
        }

        // --- LOCATION PICKER LOGIC ---
        window.openLocPicker = (type) => {
            activeEditType = type; // pickup or dropoff
            const titleEl = document.getElementById('loc-picker-title');
            const myLocBtn = document.getElementById('btn-my-loc');
            
            titleEl.innerText = type === 'pickup' ? "Set Pickup Location" : "Set Drop Off Location";
            
            // For Drop Off, hide "My Location" (User said "without my current location")
            if(type === 'dropoff') {
                myLocBtn.style.display = 'none';
            } else {
                myLocBtn.style.display = 'flex';
            }
            
            // Reset Search
            document.getElementById('search-input').value = "";
            document.getElementById('loc-picker-modal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('loc-picker-modal').classList.add('active');
                initPickerMap();
            }, 200);
        }

        function initPickerMap() {
            if(pickerMap) { pickerMap.invalidateSize(); return; }
            pickerMap = L.map('picker-map-container', { zoomControl: false }).setView([6.9271, 79.8612], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd', maxZoom: 19
            }).addTo(pickerMap);

            // Click to set location
            pickerMap.on('click', async (e) => {
                const latlng = e.latlng;
                
                // Reverse Geocode to get Address (Detailed OSM Data)
                const addr = await getAddressDetails(latlng.lat, latlng.lng);
                
                selectLocationResult(latlng.lat, latlng.lng, addr);
            });
        }

        async function getAddressDetails(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await res.json();
                const addr = data.address;
                if(!addr) return "Selected Location";
                
                // Detailed Search: Road Name (Bold) + City/District (Grey)
                const road = addr.road || "";
                const city = addr.city || addr.town || addr.county || "";
                const dist = addr.state_district || addr.state || "";
                
                if(city) return `${road}, ${city}`; // "Main St, Colombo"
                if(road && dist) return `${road}, ${dist}`;
                return city || road || "Pinned Location";
            } catch(e) { return "Pinned Location"; }
        }

        window.getMyLocation = async () => {
            if(!navigator.geolocation) return showToast("GPS not supported", "error");
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                const addr = await getAddressDetails(latlng.lat, latlng.lng);
                selectLocationResult(latlng.lat, latlng.lng, addr);
            }, (err) => {
                showToast("Could not get location. Try Settings.", "error");
            }, { enableHighAccuracy: true });
        }

        window.activateMapPicker = () => {
            // Logic handled by map click, visual only
            showToast("Tap on the map to pin the location");
        }

        function selectLocationResult(lat, lon, name) {
            if(activeEditType === 'pickup') {
                pickupCoords = { lat, lon };
                pickupAddress = name;
                document.getElementById('lbl-pickup').innerText = name;
                
                // Remove OLD marker immediately (Fix duplicate issue)
                if(pickupMarker) mainMap.removeLayer(pickupMarker);
                
                // Create Blue Dot Pulse Marker
                pickupMarker = L.circleMarker([lat, lon], {
                    radius: 8, color: '#2196F3', fillColor: '#2196F3', fillOpacity: 0.3
                }).addTo(mainMap);
                
            } else {
                dropoffCoords = { lat, lon };
                dropoffAddress = name;
                document.getElementById('lbl-dropoff').innerText = name;
                
                // Remove OLD marker immediately
                if(dropoffMarker) mainMap.removeLayer(dropoffMarker);
                
                // Create Red Triangle Marker
                dropoffMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-pin-red',
                        html: '<i class="fa-solid fa-location-dot" style="color:#D50000; font-size:24px; text-shadow:0 2px 2px rgba(0,0,0,0.3);"></i>',
                        iconSize: [24, 24], iconAnchor: [12, 24]
                    })
                }).addTo(mainMap);
            }

            // Close Picker
            closeLocPicker();
            
            // Check if both set to enable vehicles
            if(pickupCoords && dropoffCoords) {
                document.getElementById('btn-vehicles').disabled = false;
                mainMap.fitBounds([pickupCoords, dropoffCoords], { padding: [50, 50] });
            }
        }

        // --- SEARCH LOGIC ---
        let debounceTimer;
        window.handleSearchInput = (e) => {
            if(debounceTimer) clearTimeout(debounceTimer);
            const q = e.target.value;
            if(q.length < 3) return;
            
            debounceTimer = setTimeout(async () => {
                // Using Nominatim for detailed data
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=lk&limit=5&addressdetails=1`);
                const data = await res.json();
                displaySearchResults(data);
            }, 500);
        }

        function displaySearchResults(data) {
            const container = document.getElementById('search-results-container'); // We will create this in HTML
            // Since we need to inject into the map picker modal, let's create a list overlay there
            const listContainer = document.createElement('div');
            listContainer.style.position = 'absolute';
            listContainer.style.top = '60px';
            listContainer.style.left = '20px';
            listContainer.style.width = 'calc(100% - 40px)';
            listContainer.style.zIndex = '3000';
            listContainer.style.maxHeight = '200px';
            listContainer.style.overflowY = 'auto';
            listContainer.style.background = 'white';
            listContainer.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
            listContainer.style.borderRadius = '10px';
            listContainer.id = 'search-results-container';

            if(!data || data.length === 0) listContainer.remove();
            
            listContainer.innerHTML = '';
            data.forEach(place => {
                const div = document.createElement('div');
                div.style.padding = '12px 15px';
                div.style.borderBottom = '1px solid #eee';
                div.style.cursor = 'pointer';
                div.style.fontSize = '13px';
                // Highlight road name
                const name = place.display_name || place.address.road || "Location";
                div.innerHTML = `<div style="font-weight:600; color:#333;">${name}</div>`;
                if(place.display_name && place.address) {
                    const sub = place.address.city || place.address.town || "";
                    div.innerHTML += `<div style="font-size:11px; color:#666;">${sub}</div>`;
                }
                div.onclick = () => {
                    const latlng = { lat: place.lat, lon: place.lon };
                    const addr = await getAddressDetails(latlng.lat, latlng.lng);
                    selectLocationResult(latlng.lat, latlng.lng, addr);
                }
                listContainer.appendChild(div);
            });
            
            // Append to map area (we need to find the wrap)
            const mapWrap = document.querySelector('.picker-map-wrap');
            if(mapWrap) mapWrap.appendChild(listContainer);
        }


        // --- ROUTING LOGIC (Dijkstra / OSRM) ---
        window.calculateRoutes = async () => {
            if(!pickupCoords || !dropoffCoords) return showToast("Please select both locations.", "error");

            const modal = document.getElementById('route-select-modal');
            modal.style.display = 'flex';
            
            // Use Leaflet Routing Machine (OSRM)
            // This simulates Dijkstra/A* to find closest route
            routingControl = L.Routing.control({
                waypoints: [L.latLng(pickupCoords.lat, pickupCoords.lng), L.latLng(dropoffCoords.lat, dropoffCoords.lng)],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/routed-car/v1' }), // OSRM is fast and free
                lineOptions: { styles: [{color: '#D50000', weight: 6}, {color: '#888', weight: 6, opacity: 0.6, dashArray: '5, 5'}] }, // Red & Grey for alternatives
                altLineOptions: { styles: [{color: '#D50000', weight: 6}] },
                showAlternatives: true,
                addWaypoints: false,
                routeWhileDragging: false,
                fitSelectedRoutes: true,
                createMarker: function() { return null; } // We use custom markers
            }).addTo(mainMap);
        }

        // Hook into routing events
        // LRM (Leaflet Routing Machine) is an abstraction, we listen to 'routesfound' event on the 'map' or 'control'
        // Since we created a control instance, we can attach the listener directly to it or check the event
        // Note: In pure JS without bundlers, accessing the internal control instance directly is tricky, but `addTo(map)` attaches it to the map.
        // We will use the `routingfound` event on the control object itself if accessible, or rely on the map event.
        mainMap.on('routingfound', (e) => {
            const routes = e.routes; // Returns an array of routes
            if(!routes || routes.length === 0) return;

            const container = document.getElementById('route-options-container');
            container.innerHTML = '';

            // Sort by duration (Fastest is usually first in OSRM, or we check summary.totalTime)
            const sortedRoutes = routes.sort((a, b) => a.summary.totalTime - b.summary.totalTime);

            // Generate HTML for each route
            sortedRoutes.forEach((route, index) => {
                const distKm = (route.summary.totalDistance / 1000).toFixed(1);
                const timeMin = Math.round(route.summary.totalTime / 60);
                
                // Determine type (Mock Logic for Expressway vs Normal)
                const isExpress = index === 1; // Second route is usually alt/exp
                const isRec = index === 0; // First route is usually best

                const div = document.createElement('div');
                div.className = `route-opt ${isRec ? 'selected' : ''}`;
                
                // Route Name
                const routeName = isExpress ? "Expressway (Fastest)" : "Normal Way (Scenic)";
                
                // Directions HTML (Steps from OSRM)
                // OSRM instructions array is sometimes available in summary, sometimes hidden.
                // We'll mock directions for now or use generic if available.
                // Since `route.name` in OSRM usually gives "Route A", "Route B", etc.
                
                let infoHtml = `<div class="route-info">
                    <span class="route-title">${routeName}</span>
                    <span class="route-meta">${distKm} km • ${timeMin} mins</span>
                </div>
                <button class="route-info-btn" onclick="showDirections(${index})"><i class="fa-solid fa-circle-info"></i></button>
                ${isExpress ? '<span class="warn-cost">Tolls May Charge</span>' : '<span style="color:#4CAF50; font-size:11px; font-weight:600;">Eco Friendly</span>'}`;

                if(isRec) div.innerHTML = `<div class="rec-badge">Most Recommend</div>` + infoHtml;
                
                div.onclick = () => {
                    // UI Selection logic
                    document.querySelectorAll('.route-opt').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    
                    // Draw Line on Map
                    // Routing control handles drawing, but we might want to force redraw to highlight
                    // In LRM, clicking the route usually selects it.
                    // We will set a global variable `selectedRouteData`
                    selectedRouteData = route;
                    
                    // Re-trigger routing control's 'setWaypoints' logic to force redraw (hacky but effective in this context)
                    // Note: Standard LRM doesn't expose direct redraw easily without complex manipulation. 
                    // Instead, we will let the user select visually.
                };
                
                container.appendChild(div);
            });

            // Trigger initial draw (Route 0 is default)
            if(selectedRouteData) {
                // Hack: We need to actually draw the specific route. 
                // Since LRM draws automatically, we just wait for the event.
                // But we can force the active route.
                const firstOpt = container.querySelector('.route-opt');
                if(firstOpt) firstOpt.click(); 
            }
        });

        window.showDirections = (index) => {
            const routeIndex = parseInt(index);
            if(!selectedRouteData) return;

            // Show modal
            const modal = document.getElementById('directions-modal');
            const list = document.getElementById('dir-steps');
            list.innerHTML = '';
            modal.classList.remove('hidden');

            // Fetch Route Data from OSRM (Ideally accessible via a stored reference, here we rely on selection logic)
            // We will generate mock steps based on "Straight line" assumption for this demo since we can't easily query the object
            // Real OSRM provides `instructions` array in the JSON if supported by profile.
            
            const steps = [
                { icon: "fa-solid fa-location-dot", text: "Start from " + (pickupAddress || "Pickup") },
                { icon: "fa-solid fa-arrow-right", text: "Head towards " + (selectedRouteData.name === "Normal Way" ? "main road" : "expressway") },
                { icon: "fa-solid fa-arrow-right", text: selectedRouteData.name === "Normal Way" ? "Continue straight" : "Take Expressway" },
                { icon: "fa-solid fa-arrow-right", text: "Take exit ramp towards " + (dropoffAddress || "Dropoff") },
                { icon: "fa-solid fa-location-dot", text: "Arrive at destination" }
            ];

            steps.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'dir-step';
                div.innerHTML = `<i class="fa-solid ${s.icon}"></i> <span>${s.text}</span>`;
                list.appendChild(div);
            });
        }

        window.selectVehicle = (type) => {
            selectedVehicle = type; // 'Tuk' or 'Moto'
            // Update UI highlight
            document.querySelectorAll('.vehicle-sheet > div > div').forEach(div => {
                div.style.borderColor = (div.innerText.includes(type) ? 'var(--primary-red)' : '#eee');
                div.style.background = (div.innerText.includes(type) ? '#fff5f5' : 'white');
            });
        }

        window.confirmVehicle = () => {
            // Calculate Price
            const distKm = (mainMap.distance([pickupCoords.lat, pickupCoords.lng], [dropoffCoords.lat, dropoffCoords.lng]) / 1000).toFixed(2);
            const distVal = parseFloat(distKm);
            
            let price = 100; // First km flat
            let remaining = distVal - 1;
            if(remaining < 0) remaining = 0;

            // Logic
            let rate = 0;
            if(selectedVehicle === 'Tuk') {
                if(distVal <= 1) rate = 0;
                else if(distVal <= 5) rate = 70;
                else if(distVal <= 10) rate = 65;
                else rate = 60;
                
                price += (remaining * rate);
            } else { // Moto
                if(distVal <= 1) rate = 0;
                else if(distVal <= 10) rate = 65;
                else if(distVal <= 50) rate = 60;
                else rate = 50;
                
                price += (remaining * rate);
            }

            const total = Math.floor(price);
            
            // Update Summary
            document.getElementById('sum-pickup').innerText = pickupAddress;
            document.getElementById('sum-dropoff').innerText = dropoffAddress;
            document.getElementById('sum-dist').innerText = distVal + " km";
            document.getElementById('sum-time').innerText = "15 min"; // Mock
            document.getElementById('sum-veh').innerText = selectedVehicle;
            document.getElementById('sum-price').innerText = "LKR " + total;

            // Collapse Top Card
            document.getElementById('ride-top-card').classList.add('collapsed');
            document.getElementById('ride-expanded-ui').classList.add('hidden');
            document.getElementById('ride-collapsed-ui').classList.remove('hidden');
            
            // Close Route Modal
            document.getElementById('route-select-modal').classList.add('hidden');
        }

        window.bookRide = () => {
            showToast(i18n[currentLang].book_now);
            setTimeout(() => window.location.reload(), 2000); // Reset app
        }

        // --- INIT UI ---
        function initUI() {
            const name = currentUser.fullName ? currentUser.fullName.split(' ')[0] : 'User';
            document.getElementById('ui-name').innerText = name;
            document.getElementById('prof-view-name').innerText = currentUser.fullName || 'User';
            document.getElementById('prof-view-email').innerText = currentUser.email || '';
            if(currentUser.profilePic) {
                document.getElementById('ui-avatar').src = currentUser.profilePic;
                document.getElementById('prof-view-img').src = currentUser.profilePic;
            }
            updateLangState();
        }

    </script>
</body>
</html>
