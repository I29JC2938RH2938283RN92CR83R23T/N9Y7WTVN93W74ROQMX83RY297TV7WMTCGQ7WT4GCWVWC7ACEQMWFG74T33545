<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Super App</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet Maps & Routing -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <style>
        /* --- General Styles --- */
        :root {
            --primary-red: #D50000;
            --text-dark: #333;
            --bg-grey: #f8f9fa;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Poppins', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
            background-color: var(--primary-red);
            overflow: hidden; /* Prevent body scroll */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        /* --- 1. HEADER --- */
        #header-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 110px;
            z-index: 10; padding: 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .name-pill {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            padding: 5px 15px 5px 5px;
            border-radius: 40px;
            display: flex; align-items: center; gap: 10px;
            border: 1px solid rgba(255,255,255,0.4);
            color: white; max-width: 60%; cursor: pointer;
        }
        .pill-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid white; }
        .pill-info { display: flex; flex-direction: column; }
        .pill-hello { font-size: 13px; font-weight: 700; line-height: 1.1; }
        .pill-greeting { font-size: 10px; opacity: 0.95; font-weight: 400; line-height: 1.1; margin-top: 2px; }

        .lang-pill {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.4);
            color: white; font-size: 13px; font-weight: 600;
            cursor: pointer; display: flex; gap: 5px; align-items: center;
        }
        .lang-pill span.active { text-decoration: underline; font-weight: 800; }

        /* --- 2. MAIN CARD --- */
        #main-card {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: calc(100% - 80px);
            background: white;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
            z-index: 5;
            padding: 25px 20px 80px 20px;
            box-sizing: border-box;
            overflow-y: auto; /* Scroll content only */
            animation: slideUp 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Views */
        .tab-view { display: none; flex-direction: column; gap: 15px; width: 100%; padding-bottom: 20px;}
        .tab-view.active-view { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Services Grid */
        .services-grid { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 5px; }
        .service-btn { display: flex; flex-direction: column; align-items: center; width: 32%; cursor: pointer; }
        .svc-img-box {
            width: 100%; aspect-ratio: 1/1; background: var(--bg-grey); border-radius: 20px; margin-bottom: 8px;
            display: flex; justify-content: center; align-items: center; border: 1px solid #eee; overflow: hidden;
            transition: transform 0.2s;
        }
        .svc-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .service-btn:active .svc-img-box { transform: scale(0.95); }
        .svc-label { font-weight: 700; font-size: 13px; color: var(--text-dark); }

        /* Action Row */
        .home-action-row { display: flex; justify-content: space-between; gap: 12px; width: 100%; }
        .action-pill {
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
            background: white; border: 1px solid #eee; border-radius: 50px; padding: 10px;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .action-pill:active { background: #f5f5f5; transform: scale(0.98); }
        .action-pill img { width: 22px; height: 22px; border-radius: 50%; }
        .action-label { font-size: 13px; font-weight: 600; color: #444; }

        /* Activity & Promo */
        .activity-card {
            background: white; border: 1px solid #eee; border-radius: 18px; padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); cursor: pointer;
        }
        .act-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .act-title { font-size: 15px; font-weight: 700; color: #333; }
        .act-content { background: #f8f9fa; border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 10px; color: #888; font-size: 13px; }

        .promo-strip-wrapper { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding-bottom: 5px; }
        .promo-strip-item {
            flex: 0 0 85%; aspect-ratio: 3/1; border-radius: 15px; overflow: hidden; 
            border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .promo-strip-item img { width: 100%; height: 100%; object-fit: cover; }

        /* --- 3. BOTTOM NAV --- */
        #bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 20;
            display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #f0f0f0;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #aaa; cursor: pointer; width: 25%; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .nav-item.active { color: var(--primary-red); }

        /* --- MAP & OVERLAYS --- */
        /* Shared Map Container */
        #shared-map-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #e5e5e5; z-index: 50; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        #shared-map-container.active { transform: translateY(0); }
        #map-obj { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        
        /* Close Button Generic */
        .close-overlay-btn {
            position: absolute; top: 40px; right: 20px; z-index: 200;
            width: 35px; height: 35px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; color: #333; font-size: 16px; border: none;
        }

        /* Top Card (Ride & Flash) */
        .overlay-card {
            position: absolute; top: 20px; left: 5%; width: 90%;
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 100;
            transition: all 0.3s ease; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        /* Minimized State (Pill) */
        .overlay-card.minimized {
            width: auto; left: 50%; transform: translateX(-50%); top: 40px;
            padding: 8px 15px; border-radius: 30px; height: auto;
            flex-direction: row; align-items: center; gap: 10px;
        }
        .overlay-card.minimized .full-content { display: none; }
        .overlay-card.minimized .min-content { display: flex; align-items: center; gap: 10px; }
        .min-content { display: none; font-size: 13px; font-weight: 600; color: #333; }
        
        .loc-input {
            width: 100%; padding: 12px; background: #f8f9fa; border-radius: 12px;
            display: flex; align-items: center; gap: 10px; cursor: pointer; border: 1px solid #eee;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .dot.blue { background: #2196F3; }
        .dot.red { background: #D50000; }
        .loc-txt { font-size: 13px; font-weight: 500; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .btn-red { 
            background: var(--primary-red); color: white; border: none; padding: 14px; 
            border-radius: 12px; font-weight: 700; font-size: 14px; width: 100%; cursor: pointer; 
        }
        .btn-red:disabled { background: #ccc; }

        /* --- FLASH UI --- */
        #flash-ui-container {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: white; border-radius: 30px 30px 0 0; z-index: 100;
            display: none; flex-direction: column; padding: 20px; box-sizing: border-box;
            animation: slideUp 0.3s; height: 60%;
        }
        #flash-ui-container.active { display: flex; }
        
        .flash-big-btn-row { display: flex; gap: 15px; height: 100%; align-items: center; }
        .flash-big-btn {
            flex: 1; height: 150px; border-radius: 20px; border: 2px solid #eee;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 10px; cursor: pointer; transition: 0.2s; background: #fcfcfc;
        }
        .flash-big-btn.active-opt { border-color: var(--primary-red); background: #fff5f5; }
        .flash-emoji { font-size: 40px; }
        .flash-lbl { font-weight: 700; color: #333; }

        /* Items Grid */
        #flash-items-modal {
            position: fixed; inset: 0; background: white; z-index: 200; display: none; flex-direction: column; padding: 20px;
        }
        .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; overflow-y: auto; }
        .flash-item {
            display: flex; flex-direction: column; align-items: center; padding: 10px;
            border: 1px solid #eee; border-radius: 10px; cursor: pointer;
        }
        .flash-item.selected { border-color: var(--primary-red); background: #fff5f5; }
        .safety-txt { color: #D50000; font-size: 11px; margin-top: 20px; font-weight: 600; text-align: center; border: 1px solid #ffebee; padding: 10px; border-radius: 10px; }

        /* Agreement Modal */
        #flash-agree-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .agree-card { background: white; width: 85%; padding: 25px; border-radius: 20px; text-align: center; }

        /* --- SEARCH & RECENT --- */
        #search-modal {
            position: fixed; inset: 0; background: white; z-index: 500; 
            transform: translateY(100%); transition: 0.3s; display: flex; flex-direction: column; padding: 20px;
        }
        #search-modal.active { transform: translateY(0); }
        .recent-list { margin-top: 15px; flex: 1; overflow-y: auto; }
        .recent-item { display: flex; gap: 10px; padding: 12px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .recent-icon { color: #aaa; margin-top: 3px; }

        /* --- FINDING DRIVER OVERLAY --- */
        #finding-driver-overlay {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 350px;
            background: white; border-radius: 30px 30px 0 0; z-index: 1000;
            transform: translateY(100%); transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        #finding-driver-overlay.active { transform: translateY(0); }
        
        .loader-line {
            width: 80%; height: 4px; background: #eee; border-radius: 2px; overflow: hidden; margin: 20px 0;
        }
        .loader-bar {
            width: 30%; height: 100%; background: var(--primary-red);
            animation: moveBar 1.5s infinite ease-in-out;
        }
        @keyframes moveBar { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } }

        /* --- OTHER MODALS --- */
        .generic-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .generic-modal.active { display: flex; }
        .modal-box { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 25px; text-align: center; position: relative; }
        .close-corner { position: absolute; top: 15px; right: 15px; cursor: pointer; color: #888; font-size: 18px; }

        /* Crosshair */
        .crosshair-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 40; pointer-events: none; text-align: center; display: none;
        }
        .crosshair-container.active { display: block; }
        .crosshair-icon { font-size: 40px; color: var(--primary-red); text-shadow: 0 2px 5px rgba(255,255,255,0.8); }

        /* Route List */
        #route-list { max-height: 40vh; overflow-y: auto; margin-top: 10px; }
        .route-opt { 
            padding: 12px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 8px; 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .route-opt.selected { border: 2px solid var(--primary-red); background: #fff5f5; }

        /* Vehicle Sheet */
        #vehicle-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 65vh;
            background: white; border-radius: 30px 30px 0 0; z-index: 150;
            padding: 20px; box-sizing: border-box; transform: translateY(100%); transition: 0.3s;
            display: flex; flex-direction: column;
        }
        #vehicle-sheet.active { transform: translateY(0); }
        .vehicle-item { display: flex; align-items: center; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 15px; cursor: pointer; }
        .vehicle-item.selected { border: 2px solid var(--primary-red); background: #fff5f5; }
        
        .pin-controls {
            position: absolute; bottom: 0; width: 100%; background: white;
            padding: 20px; border-radius: 30px 30px 0 0; z-index: 150; text-align: center;
            transform: translateY(100%); transition: 0.3s;
        }
        .pin-controls.active { transform: translateY(0); }

    </style>
</head>
<body>

    <!-- 1. HEADER -->
    <div id="header-layer">
        <div class="name-pill">
            <img src="https://i.ibb.co/5xb03Q1/default-avatar.jpg" class="pill-img" id="user-img">
            <div class="pill-info">
                <span class="pill-hello">Hello <span id="user-name">User</span></span>
                <span class="pill-greeting" id="time-greeting">Welcome</span>
            </div>
        </div>
        <div class="lang-pill" onclick="cycleLang()">
            <span id="l-en" class="active">En</span><span id="l-si">à·ƒà·’</span><span id="l-ta">à®¤</span>
        </div>
    </div>

    <!-- 2. MAIN CARD -->
    <div id="main-card">
        <!-- HOME VIEW -->
        <div id="view-home" class="tab-view active-view">
            <div class="services-grid">
                <div class="service-btn" onclick="startFlow('ride')">
                    <div class="svc-img-box"><img src="https://i.ibb.co/cSDnbNVB/car-final-2.jpg"></div>
                    <span class="svc-label">Ride</span>
                </div>
                <div class="service-btn" onclick="alert('Food coming soon')">
                    <div class="svc-img-box"><img src="https://i.ibb.co/8gGtW9xc/bag-final-1.jpg"></div>
                    <span class="svc-label">Food</span>
                </div>
                <div class="service-btn" onclick="startFlow('flash')">
                    <div class="svc-img-box"><img src="https://i.ibb.co/67BshY3t/delivery-guy.png"></div>
                    <span class="svc-label">Flash</span>
                </div>
            </div>

            <div class="home-action-row">
                <div class="action-pill" onclick="openModal('emergency-modal')">
                    <img src="https://i.ibb.co/jPsHYHg6/Image-fx-15.jpg"> <span class="action-label">Emergency</span>
                </div>
                <div class="action-pill" onclick="openPlaces()">
                    <img src="https://i.ibb.co/WWpPXQCr/Image-fx-14.jpg"> <span class="action-label">Places</span>
                </div>
            </div>

            <div class="activity-card">
                <div class="act-header">
                    <span class="act-title">Ongoing Activities</span>
                    <i class="fa-solid fa-chevron-right" style="font-size:12px; color:#aaa;"></i>
                </div>
                <div class="act-content">
                    <i class="fa-solid fa-clipboard-list"></i> <span>No Ongoing Activities</span>
                </div>
            </div>

            <div class="promo-strip-wrapper">
                <div class="promo-strip-item"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>
                <div class="promo-strip-item"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>
            </div>
        </div>

        <!-- ACTIVITY VIEW -->
        <div id="view-activity" class="tab-view">
            <h2 style="margin:0;">Activity</h2>
            <div style="text-align:center; color:#aaa; margin-top:50px;">No records found</div>
        </div>
        
        <!-- PROFILE VIEW -->
        <div id="view-profile" class="tab-view">
            <h2 style="margin:0;">Profile</h2>
            <button class="btn-red" onclick="window.location.reload()" style="margin-top:20px;">Log Out</button>
        </div>
    </div>

    <!-- 3. BOTTOM NAV -->
    <div id="bottom-nav">
        <div class="nav-item active" onclick="switchView('home')"><i class="fa-solid fa-house"></i><span>Home</span></div>
        <div class="nav-item" onclick="switchView('activity')"><i class="fa-solid fa-clock-rotate-left"></i><span>Activity</span></div>
        <div class="nav-item" onclick="switchView('home')"><i class="fa-solid fa-tag"></i><span>Offers</span></div>
        <div class="nav-item" onclick="switchView('profile')"><i class="fa-solid fa-user"></i><span>Profile</span></div>
    </div>

    <!-- 4. SHARED MAP CONTAINER (Ride & Flash) -->
    <div id="shared-map-container">
        <div id="map-obj"></div>
        <button class="close-overlay-btn" onclick="closeSharedMap()"><i class="fa-solid fa-xmark"></i></button>

        <!-- Top Card -->
        <div id="map-top-card" class="overlay-card">
            <!-- Full Content -->
            <div class="full-content">
                <h3 style="margin:0 0 10px 0; text-align:center;" id="flow-title">Book a Ride</h3>
                <div class="loc-input" onclick="openSearch('pickup')">
                    <div class="dot blue"></div>
                    <span id="txt-pickup" class="loc-txt">Select Pickup Location</span>
                </div>
                <div style="height:10px;"></div>
                <div class="loc-input" onclick="openSearch('dropoff')">
                    <div class="dot red"></div>
                    <span id="txt-dropoff" class="loc-txt">Select Dropoff Location</span>
                </div>
                
                <div id="route-results-area" class="hidden">
                    <div id="route-list"></div>
                </div>

                <button class="btn-red" id="btn-find-route" onclick="calculateRoute()" style="margin-top:15px;">Find Best Route</button>
            </div>
            
            <!-- Minimized Content -->
            <div class="min-content" onclick="expandCard()">
                <div class="dot blue"></div>
                <span>Route Active</span>
                <i class="fa-solid fa-chevron-down" style="margin-left:5px;"></i>
            </div>
        </div>

        <!-- Flash Initial UI (Step 1) -->
        <div id="flash-ui-container">
            <h2 style="margin-top:0;">Courier Service</h2>
            <div class="flash-big-btn-row">
                <div class="flash-big-btn" onclick="initFlashSend()">
                    <div class="flash-emoji">ðŸ“¦</div>
                    <span class="flash-lbl">Send</span>
                </div>
                <div class="flash-big-btn" onclick="initFlashReceive()">
                    <div class="flash-emoji">ðŸšš</div>
                    <span class="flash-lbl">Receive</span>
                </div>
            </div>
        </div>

        <!-- Vehicle Sheet -->
        <div id="vehicle-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Choose Vehicle</h3>
                <i class="fa-solid fa-chevron-down" onclick="closeVehicles()"></i>
            </div>
            <div id="vehicle-list" style="overflow-y:auto; flex:1;"></div>
            <div style="border-top:1px solid #eee; padding-top:10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>Total Estimate</span>
                    <span id="final-price" style="font-weight:700; color:var(--primary-red);">LKR 0</span>
                </div>
                <button class="btn-red" onclick="startPinDrop()">Book Now</button>
            </div>
        </div>

        <!-- Pin Drop Controls -->
        <div id="pin-controls" class="pin-controls">
            <div style="margin-bottom:10px; font-weight:600;" id="pin-status">Adjust Pickup (Max 100m)</div>
            <button class="btn-red" id="btn-confirm-pin" onclick="confirmBooking()">Confirm Pickup</button>
        </div>
        
        <!-- Crosshair -->
        <div class="crosshair-container" id="crosshair">
            <i class="fa-solid fa-location-crosshairs crosshair-icon"></i>
        </div>
    </div>

    <!-- 5. SEARCH MODAL -->
    <div id="search-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Set Location</h3>
            <i class="fa-solid fa-xmark" style="font-size:24px; cursor:pointer;" onclick="closeSearch()"></i>
        </div>
        <div class="loc-input" style="background:white; border:2px solid var(--primary-red);">
            <i class="fa-solid fa-magnifying-glass" style="color:#aaa; margin-right:10px;"></i>
            <input type="text" id="inp-search" placeholder="Search..." style="border:none; outline:none; flex:1; font-family:inherit;" onkeyup="handleSearch(this.value)">
        </div>
        
        <div class="recent-list" id="recent-container">
            <!-- Recents injected here -->
        </div>
        <div id="search-results-list" class="recent-list hidden"></div>
        
        <div style="margin-top:10px; display:flex; gap:10px;">
            <button class="action-pill" onclick="setMyLocation()"><i class="fa-solid fa-location-arrow"></i> My Location</button>
            <button class="action-pill" onclick="pickOnMap()"><i class="fa-solid fa-map-pin"></i> Pick on Map</button>
        </div>
    </div>

    <!-- 6. FLASH ITEM SELECTOR -->
    <div id="flash-items-modal">
        <div style="display:flex; justify-content:space-between;"><h3>What's inside?</h3><i class="fa-solid fa-xmark" onclick="document.getElementById('flash-items-modal').style.display='none'"></i></div>
        <div class="items-grid">
            <div class="flash-item" onclick="selItem(this)"><i class="fa-solid fa-file-lines"></i><span>Docs</span></div>
            <div class="flash-item" onclick="selItem(this)"><i class="fa-solid fa-box-open"></i><span>Parcel</span></div>
            <div class="flash-item" onclick="selItem(this)"><i class="fa-solid fa-shirt"></i><span>Clothes</span></div>
            <div class="flash-item" onclick="selItem(this)"><i class="fa-solid fa-laptop"></i><span>Electronics</span></div>
            <div class="flash-item" onclick="selItem(this)"><i class="fa-solid fa-utensils"></i><span>Food</span></div>
            <div class="flash-item" onclick="selItem(this)"><i class="fa-solid fa-key"></i><span>Keys</span></div>
        </div>
        <div class="safety-txt">PROHIBITED: Illegal items, Cash, Jewelry, Dangerous Goods.</div>
        <button class="btn-red" style="margin-top:auto;" onclick="showFlashAgree()">Continue</button>
    </div>

    <!-- 7. FLASH AGREEMENT -->
    <div id="flash-agree-modal">
        <div class="agree-card">
            <h3 style="color:var(--primary-red);">Agreement</h3>
            <p style="font-size:12px; color:#666;">I confirm that the package does not contain any illegal or prohibited items. I assume full responsibility for the contents.</p>
            <div style="margin:20px 0;"><input type="checkbox" id="chk-agree"> I Agree</div>
            <button class="btn-red" onclick="confirmFlashAgree()">Continue</button>
        </div>
    </div>

    <!-- 8. FINDING DRIVER -->
    <div id="finding-driver-overlay">
        <h3 style="color:var(--primary-red);">Finding a Rider...</h3>
        <div class="loader-line"><div class="loader-bar"></div></div>
        <p id="connect-msg" style="color:#666; font-size:13px; font-weight:600;">Connecting to driver...</p>
        <button class="btn-red" style="width:80%; background:#eee; color:#333;" onclick="cancelSearch()">Cancel</button>
    </div>

    <!-- 9. MODALS (Emergency, Warn, etc) -->
    <div id="emergency-modal" class="generic-modal">
        <div class="modal-box">
            <div class="close-corner" onclick="closeModal('emergency-modal')">&times;</div>
            <h3 style="color:var(--primary-red);">Emergency</h3>
            <button class="btn-red" style="margin-bottom:10px; background:#0d47a1;" onclick="window.location.href='tel:119'">Police (119)</button>
            <button class="btn-red" style="background:#43a047;" onclick="window.location.href='tel:1990'">Health (1990)</button>
        </div>
    </div>

    <div id="app-warn-modal" class="generic-modal">
        <div class="modal-box">
            <h3 style="color:var(--primary-red);">Important</h3>
            <p style="font-size:13px;">Please keep the app open during the ride to maintain connection with the driver.</p>
            <button class="btn-red" onclick="closeModal('app-warn-modal')">I Understand</button>
        </div>
    </div>
    
    <div id="places-modal" class="generic-modal" style="z-index:3000;">
        <div style="width:90%; height:80%; background:white; border-radius:20px; position:relative; overflow:hidden;">
            <button class="close-overlay-btn" style="top:10px; right:10px;" onclick="closeModal('places-modal')"><i class="fa-solid fa-xmark"></i></button>
            <iframe id="places-frame" style="width:100%; height:100%; border:none;"></iframe>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let map = null, routingControl = null;
        let userLoc = null; // [lat, lng]
        let pickupLoc = null, dropoffLoc = null; // {lat, lng, address}
        let markers = { pickup: null, dropoff: null };
        let activeMode = null; // 'ride' or 'flash'
        let activeField = null; // 'pickup' or 'dropoff'
        let recentLocs = { pickup: [], dropoff: [] };
        let routeData = []; 
        let selectedRouteIdx = 0;
        let selectedVehicle = null;
        let pinMapMode = false;

        // --- INIT ---
        window.onload = function() {
            // Update greeting
            const h = new Date().getHours();
            document.getElementById('time-greeting').innerText = h < 12 ? 'Good Morning' : h < 18 ? 'Good Afternoon' : 'Good Evening';
            
            // Get Location
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLoc = [pos.coords.latitude, pos.coords.longitude];
                }, err => alert("Please enable location for the best experience."));
            }

            // Load Recents
            const stored = localStorage.getItem('speedo_recents');
            if(stored) recentLocs = JSON.parse(stored);
        };

        // --- UI SWITCHING ---
        window.switchView = (view) => {
            document.querySelectorAll('.tab-view').forEach(e => e.classList.remove('active-view'));
            document.getElementById('view-'+view).classList.add('active-view');
        };

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        
        window.openPlaces = () => {
            document.getElementById('places-frame').src = `https://www.google.com/maps?q=Sri+Lanka&output=embed`;
            openModal('places-modal');
        }

        // --- MAP ENGINE ---
        function initMap() {
            if(!map) {
                map = L.map('map-obj', {zoomControl:false}).setView(userLoc || [6.9271, 79.8612], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            // Reset layers
            if(routingControl) { map.removeControl(routingControl); routingControl = null; }
            if(markers.pickup) map.removeLayer(markers.pickup);
            if(markers.dropoff) map.removeLayer(markers.dropoff);
            markers = { pickup: null, dropoff: null };
            pickupLoc = null; dropoffLoc = null;
            document.getElementById('txt-pickup').innerText = "Select Pickup Location";
            document.getElementById('txt-dropoff').innerText = "Select Dropoff Location";
            document.getElementById('map-top-card').classList.remove('minimized');
            document.getElementById('btn-find-route').classList.remove('hidden');
            document.getElementById('route-results-area').classList.add('hidden');
        }

        // --- FLOW START ---
        window.startFlow = (mode) => {
            activeMode = mode;
            document.getElementById('shared-map-container').classList.add('active');
            openModal('app-warn-modal'); // Warn modal logic
            
            initMap();
            
            if(mode === 'flash') {
                document.getElementById('map-top-card').classList.add('hidden');
                document.getElementById('flash-ui-container').classList.add('active');
            } else {
                document.getElementById('map-top-card').classList.remove('hidden');
                document.getElementById('flash-ui-container').classList.remove('active');
                document.getElementById('flow-title').innerText = "Book a Ride";
            }
        };

        window.closeSharedMap = () => {
            document.getElementById('shared-map-container').classList.remove('active');
            setTimeout(() => {
                document.getElementById('map-top-card').classList.remove('hidden', 'minimized');
                document.getElementById('flash-ui-container').classList.remove('active');
                document.getElementById('vehicle-sheet').classList.remove('active');
                document.getElementById('pin-controls').classList.remove('active');
                pinMapMode = false;
                document.getElementById('crosshair').classList.remove('active');
            }, 300);
        };

        // --- FLASH LOGIC ---
        window.initFlashSend = () => {
            document.getElementById('flash-items-modal').style.display = 'flex';
        };
        window.initFlashReceive = () => {
             // For receive, we skip item selection or keep it simple. Let's go to location directly.
             document.getElementById('flash-ui-container').classList.remove('active');
             document.getElementById('map-top-card').classList.remove('hidden');
             document.getElementById('flow-title').innerText = "Courier (Receive)";
        };
        window.selItem = (el) => {
            document.querySelectorAll('.flash-item').forEach(e=>e.classList.remove('selected'));
            el.classList.add('selected');
        };
        window.showFlashAgree = () => {
            if(!document.querySelector('.flash-item.selected')) return alert("Select an item type");
            document.getElementById('flash-items-modal').style.display = 'none';
            document.getElementById('flash-agree-modal').style.display = 'flex';
        };
        window.confirmFlashAgree = () => {
            if(!document.getElementById('chk-agree').checked) return alert("Please agree to terms");
            document.getElementById('flash-agree-modal').style.display = 'none';
            document.getElementById('flash-ui-container').classList.remove('active');
            document.getElementById('map-top-card').classList.remove('hidden');
            document.getElementById('flow-title').innerText = "Courier (Send)";
        };

        // --- SEARCH & LOCATION ---
        window.openSearch = (field) => {
            activeField = field;
            document.getElementById('search-modal').classList.add('active');
            document.getElementById('inp-search').value = "";
            renderRecents();
            document.getElementById('search-results-list').classList.add('hidden');
        };
        window.closeSearch = () => document.getElementById('search-modal').classList.remove('active');

        function renderRecents() {
            const list = recentLocs[activeField] || [];
            const cont = document.getElementById('recent-container');
            cont.innerHTML = list.length ? `<div style="font-size:12px; color:#aaa; margin-bottom:5px;">Recent</div>` : '';
            list.forEach(item => {
                cont.innerHTML += `
                    <div class="recent-item" onclick="selectLocation(${item.lat}, ${item.lng}, '${item.addr}')">
                        <div class="recent-icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
                        <div style="font-size:13px;">${item.addr}</div>
                    </div>`;
            });
        }

        let debounce;
        window.handleSearch = (val) => {
            clearTimeout(debounce);
            if(val.length < 3) return;
            debounce = setTimeout(async () => {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=lk&limit=5`);
                const data = await res.json();
                const cont = document.getElementById('search-results-list');
                cont.innerHTML = '';
                cont.classList.remove('hidden');
                data.forEach(p => {
                    cont.innerHTML += `
                    <div class="recent-item" onclick="selectLocation(${p.lat}, ${p.lon}, '${p.display_name.split(',')[0]}')">
                        <div class="recent-icon"><i class="fa-solid fa-location-dot"></i></div>
                        <div style="font-size:13px;"><b>${p.display_name.split(',')[0]}</b><br><span style="color:#aaa; font-size:11px;">${p.display_name}</span></div>
                    </div>`;
                });
            }, 500);
        };

        window.setMyLocation = async () => {
            if(!userLoc) return alert("Location not found");
            // Reverse Geocode
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLoc[0]}&lon=${userLoc[1]}&format=json`);
            const data = await res.json();
            selectLocation(userLoc[0], userLoc[1], data.display_name.split(',')[0]);
        };

        window.selectLocation = (lat, lng, addr) => {
            const loc = { lat: parseFloat(lat), lng: parseFloat(lng), addr: addr };
            const iconUrl = activeField === 'pickup' 
                ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png'
                : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
            
            const icon = L.icon({iconUrl: iconUrl, iconSize: [25, 41], iconAnchor: [12, 41]});

            // Update Marker (Prevent Duplicate)
            if(markers[activeField]) {
                markers[activeField].setLatLng([lat, lng]);
            } else {
                markers[activeField] = L.marker([lat, lng], {icon: icon}).addTo(map);
            }

            // Update State
            if(activeField === 'pickup') { pickupLoc = loc; document.getElementById('txt-pickup').innerText = addr; }
            else { dropoffLoc = loc; document.getElementById('txt-dropoff').innerText = addr; }

            // Save Recent
            const list = recentLocs[activeField];
            const exists = list.find(x => x.addr === addr);
            if(!exists) {
                list.unshift(loc);
                if(list.length > 3) list.pop();
                localStorage.setItem('speedo_recents', JSON.stringify(recentLocs));
            }

            map.setView([lat, lng], 15);
            closeSearch();
        };

        window.pickOnMap = () => {
            closeSearch();
            document.getElementById('map-top-card').classList.add('hidden');
            document.getElementById('crosshair').classList.add('active');
            
            // Temporary button
            const btn = document.createElement('button');
            btn.className = 'btn-red';
            btn.style.position = 'absolute'; btn.style.bottom = '20px'; btn.style.left='10%'; btn.style.width='80%'; btn.style.zIndex='500';
            btn.innerText = "Confirm Location";
            btn.onclick = async () => {
                const c = map.getCenter();
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${c.lat}&lon=${c.lng}&format=json`);
                const data = await res.json();
                selectLocation(c.lat, c.lng, data.display_name.split(',')[0]);
                document.getElementById('map-top-card').classList.remove('hidden');
                document.getElementById('crosshair').classList.remove('active');
                btn.remove();
            };
            document.getElementById('shared-map-container').appendChild(btn);
        };

        // --- ROUTING & PRICING ---
        window.calculateRoute = () => {
            if(!pickupLoc || !dropoffLoc) return alert("Select both locations");
            
            document.getElementById('btn-find-route').classList.add('hidden');
            document.getElementById('route-results-area').innerHTML = '<div style="text-align:center; padding:10px;">Calculating...</div>';
            document.getElementById('route-results-area').classList.remove('hidden');

            if(routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [L.latLng(pickupLoc), L.latLng(dropoffLoc)],
                show: false,
                lineOptions: { styles: [{color: '#D50000', weight: 5}] },
                createMarker: function() { return null; }
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                routeData = routes;
                displayRoutes(routes);
                document.getElementById('map-top-card').classList.add('minimized');
                showVehicles();
            });
        };

        function displayRoutes(routes) {
            const list = document.getElementById('route-list');
            list.innerHTML = '';
            routes.forEach((r, i) => {
                list.innerHTML += `
                <div class="route-opt ${i===0?'selected':''}" onclick="selRoute(${i})">
                    <b>Route ${i+1}</b>: ${(r.summary.totalDistance/1000).toFixed(1)}km, ${Math.round(r.summary.totalTime/60)} min
                </div>`;
            });
        }

        window.expandCard = () => document.getElementById('map-top-card').classList.remove('minimized');

        // --- SUPERIOR PRICING ALGORITHM ---
        function calculateFare(distM, timeS, type) {
            const distKm = distM / 1000;
            // Superior Logic: Base + Dist + Time + Demand + Traffic
            // Tuk Base: 100. Per KM: 80 (PickMe). Request: Double -> ~200.
            
            const RATES = {
                'bike': { base: 80, km: 150, min: 10 },
                'tuk': { base: 150, km: 220, min: 15 },
                'mini': { base: 250, km: 350, min: 20 },
                'car': { base: 400, km: 500, min: 30 },
                'van': { base: 600, km: 700, min: 40 }
            };
            
            if(activeMode === 'flash') {
                // Flash is cheaper for bike, expensive for others
                RATES['bike'].km = 120; 
                RATES['tuk'].km = 200;
            }

            const r = RATES[type];
            let raw = r.base + (distKm * r.km) + ((timeS/60) * r.min);
            
            // Random Traffic/Demand Multiplier (Simulation)
            const multiplier = 1.0 + (Math.random() * 0.2); // 0% - 20% surge
            
            return Math.ceil(raw * multiplier / 10) * 10; // Round to nearest 10
        }

        function showVehicles() {
            const sheet = document.getElementById('vehicle-sheet');
            const list = document.getElementById('vehicle-list');
            const route = routeData[selectedRouteIdx];
            
            sheet.classList.add('active');
            list.innerHTML = '';
            
            let types = activeMode === 'flash' ? ['bike', 'tuk'] : ['bike', 'tuk', 'mini', 'car', 'van'];
            
            types.forEach(t => {
                const price = calculateFare(route.summary.totalDistance, route.summary.totalTime, t);
                const name = t.charAt(0).toUpperCase() + t.slice(1);
                list.innerHTML += `
                    <div class="vehicle-item" onclick="selVeh(this, '${t}', ${price})">
                        <div style="width:50px; height:50px; background:#eee; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-right:15px;">
                            <i class="fa-solid fa-${t==='bike'?'motorcycle':t==='tuk'?'shuttle-van':t==='van'?'bus':'car'}"></i>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:700;">${name}</div>
                            <div style="font-size:12px; color:#888;">${activeMode==='flash'?'Courier':'Passenger'}</div>
                        </div>
                        <div style="font-weight:700;">LKR ${price}</div>
                    </div>
                `;
            });
        }
        
        window.closeVehicles = () => document.getElementById('vehicle-sheet').classList.remove('active');
        
        window.selVeh = (el, type, price) => {
            document.querySelectorAll('.vehicle-item').forEach(e=>e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('final-price').innerText = `LKR ${price}`;
            selectedVehicle = { type, price };
        };

        // --- PIN DROP & BOOKING ---
        let pinRadiusCircle;
        window.startPinDrop = () => {
            if(!selectedVehicle) return alert("Select a vehicle");
            closeVehicles();
            document.getElementById('map-top-card').classList.add('hidden');
            
            // Enable Pin Mode
            pinMapMode = true;
            map.setZoom(18);
            map.panTo(pickupLoc);
            
            // Show Radius (100m)
            if(pinRadiusCircle) map.removeLayer(pinRadiusCircle);
            pinRadiusCircle = L.circle(pickupLoc, {color:'var(--primary-red)', radius: 100, fillOpacity:0.1}).addTo(map);
            
            document.getElementById('pin-controls').classList.add('active');
            document.getElementById('crosshair').classList.add('active');
            
            map.on('move', checkPinRadius);
        };

        function checkPinRadius() {
            if(!pinMapMode) return;
            const c = map.getCenter();
            const dist = L.latLng(pickupLoc).distanceTo(c);
            const btn = document.getElementById('btn-confirm-pin');
            const txt = document.getElementById('pin-status');
            
            if(dist <= 100) {
                btn.disabled = false;
                btn.style.background = 'var(--primary-red)';
                txt.innerText = "Location OK";
                txt.style.color = "green";
            } else {
                btn.disabled = true;
                btn.style.background = '#ccc';
                txt.innerText = "Too far from pickup (Max 100m)";
                txt.style.color = "red";
            }
        }

        window.confirmBooking = () => {
            document.getElementById('pin-controls').classList.remove('active');
            document.getElementById('crosshair').classList.remove('active');
            if(pinRadiusCircle) map.removeLayer(pinRadiusCircle);
            pinMapMode = false;
            
            // Show Finder
            const finder = document.getElementById('finding-driver-overlay');
            finder.classList.add('active');
            
            // Calculate Arrival Time
            const now = new Date();
            const arrival = new Date(now.getTime() + 4*60000); // +4 mins
            const timeStr = arrival.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            document.getElementById('connect-msg').innerText = `Connecting you to a driver by ${timeStr}...`;
            
            // Simulation
            setTimeout(() => {
                alert("Driver Found! (Simulation End)");
                finder.classList.remove('active');
                closeSharedMap();
            }, 5000);
        };

        window.cancelSearch = () => {
            document.getElementById('finding-driver-overlay').classList.remove('active');
            document.getElementById('map-top-card').classList.remove('hidden');
        };

        // --- UTILS ---
        window.cycleLang = () => {
            // Placeholder for lang switch logic
            alert("Language switched (UI Update placeholder)");
        };

    </script>
</body>
</html>
