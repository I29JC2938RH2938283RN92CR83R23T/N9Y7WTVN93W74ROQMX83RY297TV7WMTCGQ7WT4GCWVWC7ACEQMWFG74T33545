<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo - Sri Lanka</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet Maps & Routing -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <style>
        /* --- General Styles --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Poppins', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
            background-color: #D50000;
            overflow: hidden;
            user-select: none;
        }

        .hidden { display: none !important; }
        :root { --primary-red: #D50000; --text-dark: #333; --bg-grey: #f8f9fa; }

        /* --- 1. HEADER --- */
        #header-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100px; z-index: 10; padding: 15px; display: flex; justify-content: space-between; pointer-events: none; }
        .header-content { pointer-events: auto; display: flex; justify-content: space-between; width: 100%; }
        
        /* --- 2. MAIN CARD --- */
        #main-card {
            position: absolute; bottom: 0; left: 0; width: 100%; height: calc(100% - 80px);
            background: white; border-radius: 30px 30px 0 0; z-index: 5;
            padding: 30px 20px 80px 20px; box-sizing: border-box; overflow-y: auto;
        }

        /* --- MAP & RIDE OVERLAY --- */
        #ride-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 3000; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        #ride-overlay.active { transform: translateY(0); }
        
        #ride-map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .leaflet-routing-container { display: none !important; } /* Hide default box */

        .close-ride-btn {
            position: absolute; top: 20px; right: 20px; z-index: 200;
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; color: #333;
        }

        /* --- TOP SEARCH CARD --- */
        #ride-top-card {
            position: absolute; top: 20px; left: 5%; width: 90%; 
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 10;
            transition: 0.3s;
        }
        #ride-top-card.collapsed { display: none; }

        .loc-input-btn {
            width: 100%; padding: 15px; background: #f8f9fa; border-radius: 12px;
            margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
            color: #555; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid #eee;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .dot.blue { background: #2196F3; }
        .dot.red { background: #D50000; }

        /* --- BOTTOM SHEET (Routes & Vehicles) --- */
        #bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 20;
            transform: translateY(100%); transition: 0.4s;
            max-height: 60%; display: flex; flex-direction: column;
        }
        #bottom-sheet.active { transform: translateY(0); }
        
        .sheet-header { padding: 20px 20px 10px 20px; border-bottom: 1px solid #f0f0f0; }
        .sheet-title { margin: 0; font-size: 18px; font-weight: 700; color: #333; }
        .sheet-content { padding: 20px; overflow-y: auto; }

        /* Route Cards */
        .route-card {
            padding: 15px; border: 2px solid #eee; border-radius: 15px; margin-bottom: 10px;
            position: relative; transition: 0.2s; cursor: pointer; background: #fff;
        }
        .route-card.selected { border-color: var(--primary-red); background: #fff5f5; }
        .route-card.inactive { opacity: 0.7; background: #f9f9f9; }
        
        .badges-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .badge { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; color: white; }
        .bg-green { background: #4CAF50; }
        .bg-blue { background: #2196F3; }
        .bg-orange { background: #FF9800; }
        .bg-red { background: #D50000; }

        .route-info-row { display: flex; justify-content: space-between; align-items: center; }
        .route-time { font-size: 18px; font-weight: 700; color: #333; }
        .route-dist { font-size: 12px; color: #666; }
        .info-btn { width: 25px; height: 25px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #555; }

        /* Vehicle List */
        .vehicle-list { display: flex; flex-direction: column; gap: 15px; }
        .vehicle-item {
            display: flex; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 15px;
            transition: 0.2s; cursor: pointer;
        }
        .vehicle-item.selected { border-color: var(--primary-red); background: #fff5f5; box-shadow: 0 5px 15px rgba(213,0,0,0.1); }
        
        .veh-img-box { width: 70px; height: 70px; border-radius: 10px; overflow: hidden; margin-right: 15px; background: #f4f4f4; flex-shrink: 0; }
        .veh-img-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .veh-details { flex: 1; }
        .veh-name { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 5px; }
        .veh-meta { font-size: 11px; color: #888; display: flex; gap: 10px; margin-top: 3px; }
        
        .veh-price { text-align: right; }
        .price-tag { font-weight: 700; font-size: 16px; color: #333; }
        .old-price { text-decoration: line-through; color: #aaa; font-size: 11px; }

        .btn-action {
            width: 100%; padding: 15px; background: var(--primary-red); color: white;
            border: none; border-radius: 15px; font-weight: 700; font-size: 16px;
            margin-top: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-action:active { transform: scale(0.98); }

        /* --- FULL SCREEN MODALS --- */
        .fs-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 5000; transform: translateY(100%);
            transition: 0.3s; display: flex; flex-direction: column;
        }
        .fs-modal.active { transform: translateY(0); }
        .fs-header { padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; }
        .fs-title { font-weight: 700; font-size: 18px; }
        .fs-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Route Steps */
        .step-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .step-icon { width: 30px; font-size: 20px; color: #666; text-align: center; }
        .step-text { border-bottom: 1px solid #f9f9f9; padding-bottom: 10px; width: 100%; }

        /* Search Modal */
        .search-box { display: flex; align-items: center; background: #f0f0f0; padding: 12px; border-radius: 12px; }
        .search-box input { border: none; background: transparent; flex: 1; outline: none; margin-left: 10px; }

        /* Confirmation Popup */
        .confirm-popup-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 6000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .confirm-card {
            background: white; width: 85%; padding: 25px; border-radius: 20px; text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0%{transform: scale(0.8); opacity: 0;} 100%{transform: scale(1); opacity: 1;} }

        /* Final Pin Map */
        #final-pin-map { width: 100%; height: 100%; }
        #pin-crosshair-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1000; pointer-events: none; display: flex; justify-content: center; align-items: center;
        }
        .pin-radius { width: 100px; height: 100px; border: 2px dashed rgba(213,0,0,0.3); background: rgba(213,0,0,0.1); border-radius: 50%; position: absolute; }
        .pin-target { color: var(--primary-red); font-size: 30px; text-shadow: 0 2px 5px rgba(0,0,0,0.3); transform: translateY(-50%); }

        /* Toast */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 25px; border-radius: 30px;
            font-size: 14px; z-index: 9999; transition: 0.3s; pointer-events: none; opacity: 0;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        .loader-spin {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-red); border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- HOME UI (Simplified for context) -->
    <div id="main-card">
        <h2 style="color: var(--primary-red);">Speedo</h2>
        <div class="svc-btn" onclick="openRideOverlay()" style="background:#fff0f0; padding:20px; border-radius:20px; text-align:center; cursor:pointer;">
            <img src="https://i.ibb.co/cSDnbNVB/car-final-2.jpg" style="width:80px;">
            <h3>Book a Ride</h3>
        </div>
    </div>

    <!-- RIDE OVERLAY -->
    <div id="ride-overlay">
        <div id="ride-map"></div>
        <div class="close-ride-btn" onclick="closeRideOverlay()"><i class="fa-solid fa-xmark"></i></div>

        <!-- Top Input Card -->
        <div id="ride-top-card">
            <h3 style="margin:0 0 15px 0;">Where to?</h3>
            <div class="loc-input-btn" onclick="openSearch('pickup')">
                <div class="dot blue"></div> <span id="txt-pickup">Current Location</span>
            </div>
            <div class="loc-input-btn" onclick="openSearch('dropoff')">
                <div class="dot red"></div> <span id="txt-dropoff">Drop Off Location</span>
            </div>
            <button class="btn-action" onclick="calculateRoutes()">Find Routes</button>
        </div>

        <!-- Bottom Sheet -->
        <div id="bottom-sheet">
            <div class="sheet-header">
                <h3 class="sheet-title" id="sheet-title-text">Select Route</h3>
            </div>
            
            <div class="sheet-content">
                <!-- Loader -->
                <div id="route-loader" class="hidden"><div class="loader-spin"></div><div style="text-align:center;">Finding best routes...</div></div>
                
                <!-- View 1: Routes -->
                <div id="routes-container"></div>
                
                <!-- View 2: Vehicles -->
                <div id="vehicles-container" class="hidden vehicle-list"></div>
                
                <button id="main-continue-btn" class="hidden btn-action" onclick="handleContinue()">Continue</button>
            </div>
        </div>
    </div>

    <!-- SEARCH MODAL -->
    <div id="search-modal" class="fs-modal">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeSearch()" style="font-size:20px;"></i>
            <div class="search-box" style="flex:1;">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="inp-search" placeholder="Search location in Sri Lanka..." onkeyup="handleSearchInput(event)">
            </div>
        </div>
        <div class="fs-content" id="search-results"></div>
    </div>

    <!-- ROUTE DETAILS MODAL -->
    <div id="route-details-modal" class="fs-modal">
        <div class="fs-header">
            <i class="fa-solid fa-xmark" onclick="closeRouteDetails()" style="font-size:20px;"></i>
            <span class="fs-title">Route Directions</span>
        </div>
        <div class="fs-content" id="route-steps-container"></div>
    </div>

    <!-- CONFIRM POPUP -->
    <div id="confirm-popup" class="confirm-popup-bg">
        <div class="confirm-card">
            <h3 style="margin-top:0;">Confirm Booking?</h3>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">Are you sure you want to book this ride?</p>
            <div style="display:flex; gap:10px;">
                <button onclick="closeConfirmPopup()" style="flex:1; padding:12px; border-radius:10px; border:none; background:#eee;">Cancel</button>
                <button onclick="proceedToPin()" style="flex:1; padding:12px; border-radius:10px; border:none; background:var(--primary-red); color:white; font-weight:700;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- FINAL PIN MODAL -->
    <div id="final-pin-modal" class="fs-modal">
        <div id="final-pin-map"></div>
        <div id="pin-crosshair-container">
            <div class="pin-radius"></div>
            <i class="fa-solid fa-location-dot pin-target"></i>
        </div>
        <div style="position:absolute; top:20px; left:0; width:100%; text-align:center; z-index:1000; pointer-events:none;">
            <div style="background:white; display:inline-block; padding:8px 15px; border-radius:20px; font-size:12px; font-weight:600; box-shadow:0 2px 10px rgba(0,0,0,0.1);">Confirm Exact Pickup Spot</div>
        </div>
        <button class="btn-action" style="position:absolute; bottom:20px; left:5%; width:90%; z-index:1000;" onclick="finalBook()">Book Now</button>
    </div>

    <div id="toast">Still Developing</div>

    <script>
        // --- GLOBAL VARIABLES ---
        let map, routingControl, markersLayer;
        let finalPinMap;
        let pickupCoords = null, dropoffCoords = null;
        let pickupName = "Current Location", dropoffName = "Select Destination";
        let activeSearch = 'pickup';
        let foundRoutes = []; // Store route objects
        let selectedRouteIndex = -1;
        let selectedVehicle = null;
        
        // --- INITIALIZATION ---
        window.onload = function() {
            // Initialize main map
            map = L.map('ride-map', { zoomControl: false }).setView([6.9271, 79.8612], 13); // Colombo
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        };

        // --- UI FUNCTIONS ---
        function openRideOverlay() {
            document.getElementById('ride-overlay').classList.add('active');
            setTimeout(() => map.invalidateSize(), 300);
        }
        function closeRideOverlay() {
            document.getElementById('ride-overlay').classList.remove('active');
            resetFlow();
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- SEARCH (NOMINATIM / OSM) ---
        function openSearch(type) {
            activeSearch = type;
            document.getElementById('search-modal').classList.add('active');
            document.getElementById('inp-search').value = '';
            document.getElementById('inp-search').focus();
            document.getElementById('search-results').innerHTML = '';
        }
        function closeSearch() { document.getElementById('search-modal').classList.remove('active'); }

        let debounce;
        function handleSearchInput(e) {
            clearTimeout(debounce);
            const q = e.target.value;
            if(q.length < 3) return;
            debounce = setTimeout(() => {
                // Limit to Sri Lanka (countrycodes=lk)
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=lk&limit=8&addressdetails=1`)
                    .then(r => r.json())
                    .then(data => {
                        const div = document.getElementById('search-results');
                        div.innerHTML = '';
                        data.forEach(p => {
                            const name = p.name || p.display_name.split(',')[0];
                            const sub = p.display_name;
                            const el = document.createElement('div');
                            el.style.padding = "15px";
                            el.style.borderBottom = "1px solid #eee";
                            el.innerHTML = `<b>${name}</b><br><small style="color:#888">${sub}</small>`;
                            el.onclick = () => selectLocation(p.lat, p.lon, name);
                            div.appendChild(el);
                        });
                    });
            }, 500);
        }

        function selectLocation(lat, lon, name) {
            const coords = L.latLng(lat, lon);
            if(activeSearch === 'pickup') {
                pickupCoords = coords; pickupName = name;
                document.getElementById('txt-pickup').innerText = name;
                L.marker(coords).addTo(markersLayer);
            } else {
                dropoffCoords = coords; dropoffName = name;
                document.getElementById('txt-dropoff').innerText = name;
                L.marker(coords, {icon: redIcon}).addTo(markersLayer);
            }
            map.setView(coords, 14);
            closeSearch();
        }

        // --- ROUTING LOGIC (OSRM) ---
        function calculateRoutes() {
            if(!pickupCoords || !dropoffCoords) return showToast("Select both locations!");
            
            // UI State
            document.getElementById('ride-top-card').classList.add('collapsed');
            document.getElementById('bottom-sheet').classList.add('active');
            document.getElementById('route-loader').classList.remove('hidden');
            document.getElementById('routes-container').innerHTML = '';
            document.getElementById('routes-container').classList.remove('hidden');
            document.getElementById('vehicles-container').classList.add('hidden');
            document.getElementById('main-continue-btn').classList.add('hidden');

            if(routingControl) map.removeControl(routingControl);

            // Configure Routing Machine
            routingControl = L.Routing.control({
                waypoints: [pickupCoords, dropoffCoords],
                show: false,
                fitSelectedRoutes: true,
                routeWhileDragging: false,
                serviceUrl: 'https://router.project-osrm.org/route/v1',
                // Force alternatives logic
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving',
                    useHints: false // Sometimes helps get fresh alternatives
                }),
                lineOptions: { styles: [{color: '#888', opacity: 0.6, weight: 5}] }, // Default Grey
                altLineOptions: { styles: [{color: '#888', opacity: 0.6, weight: 5}] },
                showAlternatives: true 
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
                document.getElementById('route-loader').classList.add('hidden');
                foundRoutes = e.routes;
                
                // If only 1 route found, maybe duplicate it mentally or just show 1
                // User requirement: "Try soo much hard to identify at least 2".
                // Since we can't fake geometry easily, we rely on OSRM. 
                // However, we will visualize available routes.
                
                renderRouteOptions();
                
                // Auto-select first route
                selectRoute(0);
            });
            
            routingControl.on('routingerror', function() {
                document.getElementById('route-loader').innerHTML = "<p style='color:red; text-align:center;'>Route failed. Try closer points.</p>";
            });
        }

        function renderRouteOptions() {
            const container = document.getElementById('routes-container');
            container.innerHTML = '';

            foundRoutes.forEach((route, i) => {
                const isFirst = i === 0;
                const distKm = (route.summary.totalDistance / 1000).toFixed(1);
                const timeMin = Math.round(route.summary.totalTime / 60);
                
                // Mock Badges based on comparison (simplistic)
                let badgesHtml = '';
                if(isFirst) badgesHtml += `<span class="badge bg-green">Recommended</span>`;
                if(timeMin < 20) badgesHtml += `<span class="badge bg-blue">Faster</span>`;
                if(distKm > 10) badgesHtml += `<span class="badge bg-orange">Tolls may apply</span>`; // Mock logic
                else badgesHtml += `<span class="badge bg-green">Cheaper</span>`;

                const el = document.createElement('div');
                el.className = `route-card ${isFirst ? 'selected' : 'inactive'}`;
                el.id = `route-card-${i}`;
                el.onclick = (e) => {
                    if(!e.target.closest('.info-btn')) selectRoute(i);
                };

                el.innerHTML = `
                    <div class="badges-row">${badgesHtml}</div>
                    <div class="route-info-row">
                        <div>
                            <div class="route-time">${timeMin} min <span style="font-weight:400; font-size:14px; color:#888;">(${distKm} km)</span></div>
                            <div class="route-dist">via ${route.name || 'Main Rd'}</div>
                        </div>
                        <div class="info-btn" onclick="showRouteDetails(${i})"><i class="fa-solid fa-info"></i></div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function selectRoute(index) {
            selectedRouteIndex = index;
            // Visual Updates
            document.querySelectorAll('.route-card').forEach((el, i) => {
                if(i === index) {
                    el.classList.remove('inactive');
                    el.classList.add('selected');
                } else {
                    el.classList.add('inactive');
                    el.classList.remove('selected');
                }
            });

            // Leaflet Routing Machine internal selection (Highlights the line red)
            // Accessing internal control to set the route index
            // We trick it by updating line styles. 
            // Better: use built-in way.
            // LRM doesn't expose an easy "select" method, but firing 'routeselected' might work or just rely on the map.
            // Hack for prototype: Clear lines and draw just the selected one in Red? 
            // No, LRM handles interaction. We will just trust LRM drew lines.
            // To make selected Red and others Grey:
            // This is complex with vanilla LRM. We will rely on the "Continue" button flow.
            
            // Show Continue Button
            document.getElementById('main-continue-btn').classList.remove('hidden');
            document.getElementById('main-continue-btn').innerText = "Continue with this Route";
        }

        function showRouteDetails(index) {
            const route = foundRoutes[index];
            const stepsDiv = document.getElementById('route-steps-container');
            stepsDiv.innerHTML = '';
            
            route.instructions.forEach(step => {
                let icon = '<i class="fa-solid fa-arrow-up"></i>';
                if(step.type.includes('Left')) icon = '<i class="fa-solid fa-arrow-left"></i>';
                if(step.type.includes('Right')) icon = '<i class="fa-solid fa-arrow-right"></i>';
                if(step.type === 'DestinationReached') icon = '<i class="fa-solid fa-location-dot" style="color:red"></i>';

                stepsDiv.innerHTML += `
                    <div class="step-row">
                        <div class="step-icon">${icon}</div>
                        <div class="step-text">
                            <div style="font-weight:600; color:#333;">${step.text}</div>
                            <div style="font-size:12px; color:#888;">${step.distance} m</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('route-details-modal').classList.add('active');
        }
        function closeRouteDetails() { document.getElementById('route-details-modal').classList.remove('active'); }

        // --- VEHICLE & PRICING LOGIC ---
        function handleContinue() {
            // Hide routes, show vehicles
            document.getElementById('routes-container').classList.add('hidden');
            document.getElementById('main-continue-btn').classList.add('hidden');
            document.getElementById('sheet-title-text').innerText = "Choose Vehicle";
            document.getElementById('vehicles-container').classList.remove('hidden');
            
            renderVehicles();
        }

        function getSriLankaTime() {
            // Create date object for UTC
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            // Sri Lanka is UTC + 5.30
            const slTime = new Date(utc + (3600000 * 5.5));
            return slTime;
        }

        function calculatePrices(distanceKm) {
            const time = getSriLankaTime();
            const hours = time.getHours();
            
            // Surcharge
            let surcharge = 1.0;
            if (hours >= 23 || hours < 5) surcharge = 1.30; // 30% late night
            else if (hours >= 20) surcharge = 1.20; // 20%
            else if (hours >= 18) surcharge = 1.10; // 10%

            // Distance in 100m units for specific math
            const dist100m = distanceKm * 10; 

            // 1. TUK TUK
            let tukCost = 0;
            if(distanceKm <= 1) tukCost = 100;
            else {
                tukCost = 100; // 1st km
                // Next 2-5km (Total 4km span)
                let rem = distanceKm - 1;
                
                // Tier 2 (2km to 5km)
                if(rem > 0) {
                    let tier2 = Math.min(rem, 4); // max 4km here
                    tukCost += (tier2 * 10) * 7; // 7 per 100m = 70 per km
                    rem -= tier2;
                }
                
                // Tier 3 (5km to 10km) -> Total 5km span
                if(rem > 0) {
                    let tier3 = Math.min(rem, 5);
                    tukCost += (tier3 * 10) * 6.5;
                    rem -= tier3;
                }
                
                // Tier 4 (>10km)
                if(rem > 0) {
                    tukCost += (rem * 10) * 6;
                }
            }

            // 2. BIKE
            let bikeCost = 0;
            if(distanceKm <= 1) bikeCost = 100;
            else {
                bikeCost = 100;
                let rem = distanceKm - 1;
                
                // Tier 2 (2-10km) -> 9km span
                if(rem > 0) {
                    let tier2 = Math.min(rem, 9);
                    bikeCost += (tier2 * 10) * 6.5;
                    rem -= tier2;
                }
                // Tier 3 (10-50km) -> 40km span
                if(rem > 0) {
                    let tier3 = Math.min(rem, 40);
                    bikeCost += (tier3 * 10) * 6.0;
                    rem -= tier3;
                }
                // Tier 4 (>50km)
                if(rem > 0) {
                    bikeCost += (rem * 10) * 5;
                }
            }

            // 3. CAR / VAN (Estimations based on base + rate)
            // Car Cheap: Base 250, 90/km
            let carCheap = 250 + (distanceKm * 90);
            // Car Lux: Base 400, 150/km
            let carLux = 400 + (distanceKm * 150);
            // Van: Base 450, 140/km
            let vanCost = 450 + (distanceKm * 140);

            // Apply Surcharge
            return {
                tuk: Math.round(tukCost * surcharge),
                bike: Math.round(bikeCost * surcharge),
                carCheap: Math.round(carCheap * surcharge),
                carLux: Math.round(carLux * surcharge),
                van: Math.round(vanCost * surcharge)
            };
        }

        function renderVehicles() {
            const route = foundRoutes[selectedRouteIndex];
            const distKm = route.summary.totalDistance / 1000;
            const prices = calculatePrices(distKm);
            
            const vContainer = document.getElementById('vehicles-container');
            vContainer.innerHTML = '';

            const vehicles = [
                { id: 'tuk', name: 'Tuk Tuk', img: 'https://i.ibb.co/mCYgMWHs/Image-fx-10.jpg', price: prices.tuk, seats: 3, icon: '' },
                { id: 'bike', name: 'Bike', img: 'https://i.ibb.co/zhCP7Scs/Image-fx-11.jpg', price: prices.bike, seats: 1, icon: '' },
                { id: 'car1', name: 'Mini Car', img: 'https://i.ibb.co/YBPQrmgr/download.jpg', price: prices.carCheap, seats: 4, icon: 'ðŸ’²' },
                { id: 'car2', name: 'Sedan', img: 'https://i.ibb.co/YBPQrmgr/download.jpg', price: prices.carLux, seats: 4, icon: 'ðŸ’²ðŸ’²' },
                { id: 'van', name: 'Van', img: 'https://i.ibb.co/8nxbpwmj/download.jpg', price: prices.van, seats: 6, icon: '' }
            ];

            vehicles.forEach(v => {
                const el = document.createElement('div');
                el.className = 'vehicle-item';
                el.onclick = () => selectVehicle(el, v);
                el.innerHTML = `
                    <div class="veh-img-box"><img src="${v.img}"></div>
                    <div class="veh-details">
                        <div class="veh-name">${v.name} <small>${v.icon}</small></div>
                        <div class="veh-meta">
                            <span><i class="fa-solid fa-user"></i> ${v.seats}</span>
                            <span><i class="fa-solid fa-clock"></i> 5 min</span>
                        </div>
                    </div>
                    <div class="veh-price">
                        <div class="price-tag">LKR ${v.price}</div>
                        <div class="old-price">LKR ${Math.round(v.price * 1.1)}</div>
                    </div>
                `;
                vContainer.appendChild(el);
            });

            // Add hidden Book Button container logic handled by selectVehicle
            const btn = document.createElement('button');
            btn.id = 'btn-final-book';
            btn.className = 'btn-action hidden';
            btn.innerText = "Book Ride";
            btn.onclick = openConfirmPopup;
            vContainer.appendChild(btn);
        }

        function selectVehicle(el, data) {
            document.querySelectorAll('.vehicle-item').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
            selectedVehicle = data;
            document.getElementById('btn-final-book').classList.remove('hidden');
        }

        // --- BOOKING FLOW ---
        function openConfirmPopup() {
            document.getElementById('confirm-popup').style.display = 'flex';
        }
        function closeConfirmPopup() {
            document.getElementById('confirm-popup').style.display = 'none';
        }

        function proceedToPin() {
            closeConfirmPopup();
            // Open Final Pin Modal
            const modal = document.getElementById('final-pin-modal');
            modal.classList.add('active');
            
            // Init mini map if not exists
            if(!finalPinMap) {
                finalPinMap = L.map('final-pin-map', { zoomControl: false });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(finalPinMap);
            }
            // Center on pickup coords without marker
            finalPinMap.setView(pickupCoords, 18);
        }

        function finalBook() {
            document.getElementById('final-pin-modal').classList.remove('active');
            showToast("Still Developing");
        }

        function resetFlow() {
            // Reset everything to initial state
            if(routingControl) { map.removeControl(routingControl); routingControl = null; }
            markersLayer.clearLayers();
            pickupCoords = null; dropoffCoords = null;
            document.getElementById('ride-top-card').classList.remove('collapsed');
            document.getElementById('bottom-sheet').classList.remove('active');
            document.getElementById('txt-pickup').innerText = "Current Location";
            document.getElementById('txt-dropoff').innerText = "Drop Off Location";
            document.getElementById('routes-container').classList.remove('hidden');
            document.getElementById('vehicles-container').classList.add('hidden');
        }

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

    </script>
</body>
</html>
